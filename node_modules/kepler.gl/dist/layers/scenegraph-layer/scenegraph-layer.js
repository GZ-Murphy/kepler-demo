"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.scenegraphVisConfigs = exports.scenegraphPosResolver = exports.scenegraphPosAccessor = exports.scenegraphOptionalColumns = exports.scenegraphRequiredColumns = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _meshLayers = require("@deck.gl/mesh-layers");

var _core = require("@loaders.gl/core");

var _addons = require("@luma.gl/addons");

var _baseLayer = _interopRequireDefault(require("../base-layer"));

var _lodash = _interopRequireDefault(require("lodash.memoize"));

var _scenegraphLayerIcon = _interopRequireDefault(require("./scenegraph-layer-icon"));

var _scenegraphInfoModal = _interopRequireDefault(require("./scenegraph-info-modal"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var scenegraphRequiredColumns = ['lat', 'lng'];
exports.scenegraphRequiredColumns = scenegraphRequiredColumns;
var scenegraphOptionalColumns = ['altitude'];
exports.scenegraphOptionalColumns = scenegraphOptionalColumns;

function fetch(url, _ref) {
  var propName = _ref.propName,
      layer = _ref.layer;

  if (propName === 'scenegraph') {
    return (0, _core.load)(url, _addons.GLTFScenegraphLoader, layer.getLoadOptions());
  }

  return fetch(url).then(function (response) {
    return response.json();
  });
}

var scenegraphPosAccessor = function scenegraphPosAccessor(_ref2) {
  var lat = _ref2.lat,
      lng = _ref2.lng,
      altitude = _ref2.altitude;
  return function (d) {
    return [// lng
    d.data[lng.fieldIdx], // lat
    d.data[lat.fieldIdx], // altitude
    altitude && altitude.fieldIdx > -1 ? d.data[altitude.fieldIdx] : 0];
  };
};

exports.scenegraphPosAccessor = scenegraphPosAccessor;

var scenegraphPosResolver = function scenegraphPosResolver(_ref3) {
  var lat = _ref3.lat,
      lng = _ref3.lng,
      altitude = _ref3.altitude;
  return "".concat(lat.fieldIdx, "-").concat(lng.fieldIdx, "-").concat(altitude ? altitude.fieldIdx : 'z');
};

exports.scenegraphPosResolver = scenegraphPosResolver;
var scenegraphVisConfigs = {
  opacity: 'opacity',
  colorRange: 'colorRange',
  //
  sizeScale: 'sizeScale',
  angleX: 'angleX',
  angleY: 'angleY',
  angleZ: 'angleZ'
};
exports.scenegraphVisConfigs = scenegraphVisConfigs;
var DEFAULT_MODEL = 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb';
var DEFAULT_TRANSITION = [0, 0, 0];
var DEFAULT_SCALE = [1, 1, 1];
var DEFAULT_COLOR = [255, 255, 255, 255];

var ScenegraphLayer =
/*#__PURE__*/
function (_Layer) {
  (0, _inherits2["default"])(ScenegraphLayer, _Layer);

  function ScenegraphLayer(props) {
    var _this;

    (0, _classCallCheck2["default"])(this, ScenegraphLayer);
    _this = (0, _possibleConstructorReturn2["default"])(this, (0, _getPrototypeOf2["default"])(ScenegraphLayer).call(this, props));

    _this.registerVisConfig(scenegraphVisConfigs);

    _this.getPosition = (0, _lodash["default"])(scenegraphPosAccessor, scenegraphPosResolver); // prepare layer info modal

    _this._layerInfoModal = (0, _scenegraphInfoModal["default"])();
    return _this;
  }

  (0, _createClass2["default"])(ScenegraphLayer, [{
    key: "formatLayerData",
    value: function formatLayerData(_, allData, filteredIndex, oldLayerData) {
      var opt = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : {};
      var columns = this.config.columns;
      var getPosition = this.getPosition(columns);

      if (!oldLayerData || oldLayerData.getPosition !== getPosition) {
        this.updateLayerMeta(allData, getPosition);
      }

      var data;

      if (oldLayerData && oldLayerData.data && opt.sameData && oldLayerData.getPosition === getPosition) {
        data = oldLayerData.data;
      } else {
        data = filteredIndex.reduce(function (accu, index) {
          var pos = getPosition({
            data: allData[index]
          }); // if doesn't have point lat or lng, do not add the point
          // deck.gl can't handle position = null

          if (!pos.every(Number.isFinite)) {
            return accu;
          }

          accu.push({
            index: index,
            data: allData[index]
          });
          return accu;
        }, []);
      }

      return {
        data: data,
        getPosition: getPosition
      };
    }
  }, {
    key: "updateLayerMeta",
    value: function updateLayerMeta(allData, getPosition) {
      var bounds = this.getPointsBounds(allData, function (d) {
        return getPosition({
          data: d
        });
      });
      this.updateMeta({
        bounds: bounds
      });
    }
  }, {
    key: "renderLayer",
    value: function renderLayer(_ref4) {
      var data = _ref4.data,
          idx = _ref4.idx,
          objectHovered = _ref4.objectHovered,
          mapState = _ref4.mapState,
          interactionConfig = _ref4.interactionConfig,
          layerInteraction = _ref4.layerInteraction;

      var layerProps = _objectSpread({
        radiusMinPixels: 1,
        radiusScale: this.getRadiusScaleByZoom(mapState)
      }, this.config.visConfig.fixedRadius ? {} : {
        radiusMaxPixels: 500
      });

      var _this$config$visConfi = this.config.visConfig,
          _this$config$visConfi2 = _this$config$visConfi.sizeScale,
          sizeScale = _this$config$visConfi2 === void 0 ? 1 : _this$config$visConfi2,
          _this$config$visConfi3 = _this$config$visConfi.angleX,
          angleX = _this$config$visConfi3 === void 0 ? 0 : _this$config$visConfi3,
          _this$config$visConfi4 = _this$config$visConfi.angleY,
          angleY = _this$config$visConfi4 === void 0 ? 0 : _this$config$visConfi4,
          _this$config$visConfi5 = _this$config$visConfi.angleZ,
          angleZ = _this$config$visConfi5 === void 0 ? 90 : _this$config$visConfi5;
      return [new _meshLayers.ScenegraphLayer(_objectSpread({}, layerProps, {}, data, {}, layerInteraction, {
        id: this.id,
        idx: idx,
        opacity: this.config.visConfig.opacity,
        fetch: fetch,
        scenegraph: this.config.visConfig.scenegraph || DEFAULT_MODEL,
        sizeScale: sizeScale,
        getTranslation: DEFAULT_TRANSITION,
        getScale: DEFAULT_SCALE,
        getOrientation: [angleX, angleY, angleZ],
        getColor: DEFAULT_COLOR,
        // picking
        pickable: true,
        // parameters
        parameters: {
          depthTest: true,
          blend: false
        },
        // update triggers
        updateTriggers: {
          getOrientation: {
            angleX: angleX,
            angleY: angleY,
            angleZ: angleZ
          }
        }
      }))];
    }
  }, {
    key: "type",
    get: function get() {
      return '3D';
    }
  }, {
    key: "requiredLayerColumns",
    get: function get() {
      return scenegraphRequiredColumns;
    }
  }, {
    key: "optionalColumns",
    get: function get() {
      return scenegraphOptionalColumns;
    }
  }, {
    key: "columnPairs",
    get: function get() {
      return this.defaultPointColumnPairs;
    }
  }, {
    key: "layerIcon",
    get: function get() {
      return _scenegraphLayerIcon["default"];
    }
  }, {
    key: "layerInfoModal",
    get: function get() {
      return {
        id: 'scenegraphInfo',
        template: this._layerInfoModal,
        modalProps: {
          title: 'How to use Scenegraph'
        }
      };
    }
  }]);
  return ScenegraphLayer;
}(_baseLayer["default"]);

exports["default"] = ScenegraphLayer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYXllcnMvc2NlbmVncmFwaC1sYXllci9zY2VuZWdyYXBoLWxheWVyLmpzIl0sIm5hbWVzIjpbInNjZW5lZ3JhcGhSZXF1aXJlZENvbHVtbnMiLCJzY2VuZWdyYXBoT3B0aW9uYWxDb2x1bW5zIiwiZmV0Y2giLCJ1cmwiLCJwcm9wTmFtZSIsImxheWVyIiwiR0xURlNjZW5lZ3JhcGhMb2FkZXIiLCJnZXRMb2FkT3B0aW9ucyIsInRoZW4iLCJyZXNwb25zZSIsImpzb24iLCJzY2VuZWdyYXBoUG9zQWNjZXNzb3IiLCJsYXQiLCJsbmciLCJhbHRpdHVkZSIsImQiLCJkYXRhIiwiZmllbGRJZHgiLCJzY2VuZWdyYXBoUG9zUmVzb2x2ZXIiLCJzY2VuZWdyYXBoVmlzQ29uZmlncyIsIm9wYWNpdHkiLCJjb2xvclJhbmdlIiwic2l6ZVNjYWxlIiwiYW5nbGVYIiwiYW5nbGVZIiwiYW5nbGVaIiwiREVGQVVMVF9NT0RFTCIsIkRFRkFVTFRfVFJBTlNJVElPTiIsIkRFRkFVTFRfU0NBTEUiLCJERUZBVUxUX0NPTE9SIiwiU2NlbmVncmFwaExheWVyIiwicHJvcHMiLCJyZWdpc3RlclZpc0NvbmZpZyIsImdldFBvc2l0aW9uIiwiX2xheWVySW5mb01vZGFsIiwiXyIsImFsbERhdGEiLCJmaWx0ZXJlZEluZGV4Iiwib2xkTGF5ZXJEYXRhIiwib3B0IiwiY29sdW1ucyIsImNvbmZpZyIsInVwZGF0ZUxheWVyTWV0YSIsInNhbWVEYXRhIiwicmVkdWNlIiwiYWNjdSIsImluZGV4IiwicG9zIiwiZXZlcnkiLCJOdW1iZXIiLCJpc0Zpbml0ZSIsInB1c2giLCJib3VuZHMiLCJnZXRQb2ludHNCb3VuZHMiLCJ1cGRhdGVNZXRhIiwiaWR4Iiwib2JqZWN0SG92ZXJlZCIsIm1hcFN0YXRlIiwiaW50ZXJhY3Rpb25Db25maWciLCJsYXllckludGVyYWN0aW9uIiwibGF5ZXJQcm9wcyIsInJhZGl1c01pblBpeGVscyIsInJhZGl1c1NjYWxlIiwiZ2V0UmFkaXVzU2NhbGVCeVpvb20iLCJ2aXNDb25maWciLCJmaXhlZFJhZGl1cyIsInJhZGl1c01heFBpeGVscyIsIkRlY2tTY2VuZWdyYXBoTGF5ZXIiLCJpZCIsInNjZW5lZ3JhcGgiLCJnZXRUcmFuc2xhdGlvbiIsImdldFNjYWxlIiwiZ2V0T3JpZW50YXRpb24iLCJnZXRDb2xvciIsInBpY2thYmxlIiwicGFyYW1ldGVycyIsImRlcHRoVGVzdCIsImJsZW5kIiwidXBkYXRlVHJpZ2dlcnMiLCJkZWZhdWx0UG9pbnRDb2x1bW5QYWlycyIsIlNjZW5lZ3JhcGhMYXllckljb24iLCJ0ZW1wbGF0ZSIsIm1vZGFsUHJvcHMiLCJ0aXRsZSIsIkxheWVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFvQkE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVPLElBQU1BLHlCQUF5QixHQUFHLENBQUMsS0FBRCxFQUFRLEtBQVIsQ0FBbEM7O0FBQ0EsSUFBTUMseUJBQXlCLEdBQUcsQ0FBQyxVQUFELENBQWxDOzs7QUFFUCxTQUFTQyxLQUFULENBQWVDLEdBQWYsUUFBdUM7QUFBQSxNQUFsQkMsUUFBa0IsUUFBbEJBLFFBQWtCO0FBQUEsTUFBUkMsS0FBUSxRQUFSQSxLQUFROztBQUNyQyxNQUFJRCxRQUFRLEtBQUssWUFBakIsRUFBK0I7QUFDN0IsV0FBTyxnQkFBS0QsR0FBTCxFQUFVRyw0QkFBVixFQUFnQ0QsS0FBSyxDQUFDRSxjQUFOLEVBQWhDLENBQVA7QUFDRDs7QUFFRCxTQUFPTCxLQUFLLENBQUNDLEdBQUQsQ0FBTCxDQUFXSyxJQUFYLENBQWdCLFVBQUFDLFFBQVE7QUFBQSxXQUFJQSxRQUFRLENBQUNDLElBQVQsRUFBSjtBQUFBLEdBQXhCLENBQVA7QUFDRDs7QUFFTSxJQUFNQyxxQkFBcUIsR0FBRyxTQUF4QkEscUJBQXdCO0FBQUEsTUFBRUMsR0FBRixTQUFFQSxHQUFGO0FBQUEsTUFBT0MsR0FBUCxTQUFPQSxHQUFQO0FBQUEsTUFBWUMsUUFBWixT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QUNBQyxRQUFBQSxjQUFjLEVBQUU7QUFDZE4sVUFBQUEsY0FBYyxFQUFFO0FBQUNqRCxZQUFBQSxNQUFNLEVBQU5BLE1BQUQ7QUFBU0MsWUFBQUEsTUFBTSxFQUFOQSxNQUFUO0FBQWlCQyxZQUFBQSxNQUFNLEVBQU5BO0FBQWpCO0FBREY7QUF6QmxCLFNBREssQ0FBUDtBQStCRDs7O3dCQTlIVTtBQUNULGFBQU8sSUFBUDtBQUNEOzs7d0JBRTBCO0FBQ3pCLGFBQU96Qix5QkFBUDtBQUNEOzs7d0JBRXFCO0FBQ3BCLGFBQU9DLHlCQUFQO0FBQ0Q7Ozt3QkFFaUI7QUFDaEIsYUFBTyxLQUFLOEUsdUJBQVo7QUFDRDs7O3dCQUVlO0FBQ2QsYUFBT0MsK0JBQVA7QUFDRDs7O3dCQUVvQjtBQUNuQixhQUFPO0FBQ0xaLFFBQUFBLEVBQUUsRUFBRSxnQkFEQztBQUVMYSxRQUFBQSxRQUFRLEVBQUUsS0FBSy9DLGVBRlY7QUFHTGdELFFBQUFBLFVBQVUsRUFBRTtBQUNWQyxVQUFBQSxLQUFLLEVBQUU7QUFERztBQUhQLE9BQVA7QUFPRDs7O0VBdkMwQ0MscUIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIDIwMTkgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXG5pbXBvcnQge1NjZW5lZ3JhcGhMYXllciBhcyBEZWNrU2NlbmVncmFwaExheWVyfSBmcm9tICdAZGVjay5nbC9tZXNoLWxheWVycyc7XG5pbXBvcnQge2xvYWR9IGZyb20gJ0Bsb2FkZXJzLmdsL2NvcmUnO1xuaW1wb3J0IHtHTFRGU2NlbmVncmFwaExvYWRlcn0gZnJvbSAnQGx1bWEuZ2wvYWRkb25zJztcblxuaW1wb3J0IExheWVyIGZyb20gJy4uL2Jhc2UtbGF5ZXInO1xuaW1wb3J0IG1lbW9pemUgZnJvbSAnbG9kYXNoLm1lbW9pemUnO1xuaW1wb3J0IFNjZW5lZ3JhcGhMYXllckljb24gZnJvbSAnLi9zY2VuZWdyYXBoLWxheWVyLWljb24nO1xuaW1wb3J0IFNjZW5lZ3JhcGhJbmZvTW9kYWxGYWN0b3J5IGZyb20gJy4vc2NlbmVncmFwaC1pbmZvLW1vZGFsJztcblxuZXhwb3J0IGNvbnN0IHNjZW5lZ3JhcGhSZXF1aXJlZENvbHVtbnMgPSBbJ2xhdCcsICdsbmcnXTtcbmV4cG9ydCBjb25zdCBzY2VuZWdyYXBoT3B0aW9uYWxDb2x1bW5zID0gWydhbHRpdHVkZSddO1xuXG5mdW5jdGlvbiBmZXRjaCh1cmwsIHtwcm9wTmFtZSwgbGF5ZXJ9KSB7XG4gIGlmIChwcm9wTmFtZSA9PT0gJ3NjZW5lZ3JhcGgnKSB7XG4gICAgcmV0dXJuIGxvYWQodXJsLCBHTFRGU2NlbmVncmFwaExvYWRlciwgbGF5ZXIuZ2V0TG9hZE9wdGlvbnMoKSk7XG4gIH1cblxuICByZXR1cm4gZmV0Y2godXJsKS50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlLmpzb24oKSk7XG59XG5cbmV4cG9ydCBjb25zdCBzY2VuZWdyYXBoUG9zQWNjZXNzb3IgPSAoe2xhdCwgbG5nLCBhbHRpdHVkZX0pID0+IGQgPT4gW1xuICAvLyBsbmdcbiAgZC5kYXRhW2xuZy5maWVsZElkeF0sXG4gIC8vIGxhdFxuICBkLmRhdGFbbGF0LmZpZWxkSWR4XSxcbiAgLy8gYWx0aXR1ZGVcbiAgYWx0aXR1ZGUgJiYgYWx0aXR1ZGUuZmllbGRJZHggPiAtMSA/IGQuZGF0YVthbHRpdHVkZS5maWVsZElkeF0gOiAwXG5dO1xuXG5leHBvcnQgY29uc3Qgc2NlbmVncmFwaFBvc1Jlc29sdmVyID0gKHtsYXQsIGxuZywgYWx0aXR1ZGV9KSA9PlxuICBgJHtsYXQuZmllbGRJZHh9LSR7bG5nLmZpZWxkSWR4fS0ke2FsdGl0dWRlID8gYWx0aXR1ZGUuZmllbGRJZHggOiAneid9YDtcblxuZXhwb3J0IGNvbnN0IHNjZW5lZ3JhcGhWaXNDb25maWdzID0ge1xuICBvcGFjaXR5OiAnb3BhY2l0eScsXG4gIGNvbG9yUmFuZ2U6ICdjb2xvclJhbmdlJyxcbiAgLy9cbiAgc2l6ZVNjYWxlOiAnc2l6ZVNjYWxlJyxcbiAgYW5nbGVYOiAnYW5nbGVYJyxcbiAgYW5nbGVZOiAnYW5nbGVZJyxcbiAgYW5nbGVaOiAnYW5nbGVaJ1xufTtcblxuY29uc3QgREVGQVVMVF9NT0RFTCA9XG4gICdodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vS2hyb25vc0dyb3VwL2dsVEYtU2FtcGxlLU1vZGVscy9tYXN0ZXIvMi4wL0R1Y2svZ2xURi1CaW5hcnkvRHVjay5nbGInO1xuY29uc3QgREVGQVVMVF9UUkFOU0lUSU9OID0gWzAsIDAsIDBdO1xuY29uc3QgREVGQVVMVF9TQ0FMRSA9IFsxLCAxLCAxXTtcbmNvbnN0IERFRkFVTFRfQ09MT1IgPSBbMjU1LCAyNTUsIDI1NSwgMjU1XTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2NlbmVncmFwaExheWVyIGV4dGVuZHMgTGF5ZXIge1xuICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgIHN1cGVyKHByb3BzKTtcblxuICAgIHRoaXMucmVnaXN0ZXJWaXNDb25maWcoc2NlbmVncmFwaFZpc0NvbmZpZ3MpO1xuICAgIHRoaXMuZ2V0UG9zaXRpb24gPSBtZW1vaXplKHNjZW5lZ3JhcGhQb3NBY2Nlc3Nvciwgc2NlbmVncmFwaFBvc1Jlc29sdmVyKTtcblxuICAgIC8vIHByZXBhcmUgbGF5ZXIgaW5mbyBtb2RhbFxuICAgIHRoaXMuX2xheWVySW5mb01vZGFsID0gU2NlbmVncmFwaEluZm9Nb2RhbEZhY3RvcnkoKTtcbiAgfVxuXG4gIGdldCB0eXBlKCkge1xuICAgIHJldHVybiAnM0QnO1xuICB9XG5cbiAgZ2V0IHJlcXVpcmVkTGF5ZXJDb2x1bW5zKCkge1xuICAgIHJldHVybiBzY2VuZWdyYXBoUmVxdWlyZWRDb2x1bW5zO1xuICB9XG5cbiAgZ2V0IG9wdGlvbmFsQ29sdW1ucygpIHtcbiAgICByZXR1cm4gc2NlbmVncmFwaE9wdGlvbmFsQ29sdW1ucztcbiAgfVxuXG4gIGdldCBjb2x1bW5QYWlycygpIHtcbiAgICByZXR1cm4gdGhpcy5kZWZhdWx0UG9pbnRDb2x1bW5QYWlycztcbiAgfVxuXG4gIGdldCBsYXllckljb24oKSB7XG4gICAgcmV0dXJuIFNjZW5lZ3JhcGhMYXllckljb247XG4gIH1cblxuICBnZXQgbGF5ZXJJbmZvTW9kYWwoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiAnc2NlbmVncmFwaEluZm8nLFxuICAgICAgdGVtcGxhdGU6IHRoaXMuX2xheWVySW5mb01vZGFsLFxuICAgICAgbW9kYWxQcm9wczoge1xuICAgICAgICB0aXRsZTogJ0hvdyB0byB1c2UgU2NlbmVncmFwaCdcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgZm9ybWF0TGF5ZXJEYXRhKF8sIGFsbERhdGEsIGZpbHRlcmVkSW5kZXgsIG9sZExheWVyRGF0YSwgb3B0ID0ge30pIHtcbiAgICBjb25zdCB7Y29sdW1uc30gPSB0aGlzLmNvbmZpZztcblxuICAgIGNvbnN0IGdldFBvc2l0aW9uID0gdGhpcy5nZXRQb3NpdGlvbihjb2x1bW5zKTtcblxuICAgIGlmICghb2xkTGF5ZXJEYXRhIHx8IG9sZExheWVyRGF0YS5nZXRQb3NpdGlvbiAhPT0gZ2V0UG9zaXRpb24pIHtcbiAgICAgIHRoaXMudXBkYXRlTGF5ZXJNZXRhKGFsbERhdGEsIGdldFBvc2l0aW9uKTtcbiAgICB9XG5cbiAgICBsZXQgZGF0YTtcbiAgICBpZiAoXG4gICAgICBvbGRMYXllckRhdGEgJiZcbiAgICAgIG9sZExheWVyRGF0YS5kYXRhICYmXG4gICAgICBvcHQuc2FtZURhdGEgJiZcbiAgICAgIG9sZExheWVyRGF0YS5nZXRQb3NpdGlvbiA9PT0gZ2V0UG9zaXRpb25cbiAgICApIHtcbiAgICAgIGRhdGEgPSBvbGRMYXllckRhdGEuZGF0YTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGF0YSA9IGZpbHRlcmVkSW5kZXgucmVkdWNlKChhY2N1LCBpbmRleCkgPT4ge1xuICAgICAgICBjb25zdCBwb3MgPSBnZXRQb3NpdGlvbih7ZGF0YTogYWxsRGF0YVtpbmRleF19KTtcblxuICAgICAgICAvLyBpZiBkb2Vzbid0IGhhdmUgcG9pbnQgbGF0IG9yIGxuZywgZG8gbm90IGFkZCB0aGUgcG9pbnRcbiAgICAgICAgLy8gZGVjay5nbCBjYW4ndCBoYW5kbGUgcG9zaXRpb24gPSBudWxsXG4gICAgICAgIGlmICghcG9zLmV2ZXJ5KE51bWJlci5pc0Zpbml0ZSkpIHtcbiAgICAgICAgICByZXR1cm4gYWNjdTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFjY3UucHVzaCh7XG4gICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgZGF0YTogYWxsRGF0YVtpbmRleF1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGFjY3U7XG4gICAgICB9LCBbXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRhdGEsXG4gICAgICBnZXRQb3NpdGlvblxuICAgIH07XG4gIH1cblxuICB1cGRhdGVMYXllck1ldGEoYWxsRGF0YSwgZ2V0UG9zaXRpb24pIHtcbiAgICBjb25zdCBib3VuZHMgPSB0aGlzLmdldFBvaW50c0JvdW5kcyhhbGxEYXRhLCBkID0+IGdldFBvc2l0aW9uKHtkYXRhOiBkfSkpO1xuICAgIHRoaXMudXBkYXRlTWV0YSh7Ym91bmRzfSk7XG4gIH1cblxuICByZW5kZXJMYXllcih7XG4gICAgZGF0YSxcbiAgICBpZHgsXG4gICAgb2JqZWN0SG92ZXJlZCxcbiAgICBtYXBTdGF0ZSxcbiAgICBpbnRlcmFjdGlvbkNvbmZpZyxcbiAgICBsYXllckludGVyYWN0aW9uXG4gIH0pIHtcbiAgICBjb25zdCBsYXllclByb3BzID0ge1xuICAgICAgcmFkaXVzTWluUGl4ZWxzOiAxLFxuICAgICAgcmFkaXVzU2NhbGU6IHRoaXMuZ2V0UmFkaXVzU2NhbGVCeVpvb20obWFwU3RhdGUpLFxuICAgICAgLi4uKHRoaXMuY29uZmlnLnZpc0NvbmZpZy5maXhlZFJhZGl1cyA/IHt9IDoge3JhZGl1c01heFBpeGVsczogNTAwfSlcbiAgICB9O1xuXG4gICAgY29uc3Qge1xuICAgICAgdmlzQ29uZmlnOiB7c2l6ZVNjYWxlID0gMSwgYW5nbGVYID0gMCwgYW5nbGVZID0gMCwgYW5nbGVaID0gOTB9XG4gICAgfSA9IHRoaXMuY29uZmlnO1xuXG4gICAgcmV0dXJuIFtcbiAgICAgIG5ldyBEZWNrU2NlbmVncmFwaExheWVyKHtcbiAgICAgICAgLi4ubGF5ZXJQcm9wcyxcbiAgICAgICAgLi4uZGF0YSxcbiAgICAgICAgLi4ubGF5ZXJJbnRlcmFjdGlvbixcbiAgICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICAgIGlkeCxcbiAgICAgICAgb3BhY2l0eTogdGhpcy5jb25maWcudmlzQ29uZmlnLm9wYWNpdHksXG5cbiAgICAgICAgZmV0Y2gsXG5cbiAgICAgICAgc2NlbmVncmFwaDogdGhpcy5jb25maWcudmlzQ29uZmlnLnNjZW5lZ3JhcGggfHwgREVGQVVMVF9NT0RFTCxcblxuICAgICAgICBzaXplU2NhbGUsXG4gICAgICAgIGdldFRyYW5zbGF0aW9uOiBERUZBVUxUX1RSQU5TSVRJT04sXG4gICAgICAgIGdldFNjYWxlOiBERUZBVUxUX1NDQUxFLFxuICAgICAgICBnZXRPcmllbnRhdGlvbjogW2FuZ2xlWCwgYW5nbGVZLCBhbmdsZVpdLFxuICAgICAgICBnZXRDb2xvcjogREVGQVVMVF9DT0xPUixcblxuICAgICAgICAvLyBwaWNraW5nXG4gICAgICAgIHBpY2thYmxlOiB0cnVlLFxuXG4gICAgICAgIC8vIHBhcmFtZXRlcnNcbiAgICAgICAgcGFyYW1ldGVyczoge2RlcHRoVGVzdDogdHJ1ZSwgYmxlbmQ6IGZhbHNlfSxcblxuICAgICAgICAvLyB1cGRhdGUgdHJpZ2dlcnNcbiAgICAgICAgdXBkYXRlVHJpZ2dlcnM6IHtcbiAgICAgICAgICBnZXRPcmllbnRhdGlvbjoge2FuZ2xlWCwgYW5nbGVZLCBhbmdsZVp9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgXTtcbiAgfVxufVxuIl19