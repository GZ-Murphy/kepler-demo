"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.HexagonIdVisConfigs = exports.hexIdResolver = exports.hexIdAccessor = exports.hexIdRequiredColumns = exports.HEXAGON_ID_FIELDS = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _get2 = _interopRequireDefault(require("@babel/runtime/helpers/get"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _lodash = _interopRequireDefault(require("lodash.memoize"));

var _baseLayer = _interopRequireDefault(require("../base-layer"));

var _deck = require("deck.gl");

var _enhancedColumnLayer = _interopRequireDefault(require("../../deckgl-layers/column-layer/enhanced-column-layer"));

var _h3Utils = require("./h3-utils");

var _h3HexagonLayerIcon = _interopRequireDefault(require("./h3-hexagon-layer-icon"));

var _defaultSettings = require("../../constants/default-settings");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var HEXAGON_ID_FIELDS = {
  hex_id: ['hex_id', 'hexagon_id', 'h3_id']
};
exports.HEXAGON_ID_FIELDS = HEXAGON_ID_FIELDS;
var hexIdRequiredColumns = ['hex_id'];
exports.hexIdRequiredColumns = hexIdRequiredColumns;

var hexIdAccessor = function hexIdAccessor(_ref) {
  var hex_id = _ref.hex_id;
  return function (d) {
    return d[hex_id.fieldIdx];
  };
};

exports.hexIdAccessor = hexIdAccessor;

var hexIdResolver = function hexIdResolver(_ref2) {
  var hex_id = _ref2.hex_id;
  return hex_id.fieldIdx;
};

exports.hexIdResolver = hexIdResolver;
var HexagonIdVisConfigs = {
  opacity: 'opacity',
  colorRange: 'colorRange',
  coverage: 'coverage',
  sizeRange: 'elevationRange',
  coverageRange: 'coverageRange',
  elevationScale: 'elevationScale'
};
exports.HexagonIdVisConfigs = HexagonIdVisConfigs;

function hexToRgb(hex) {
  var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  var r = parseInt(result[1], 16);
  var g = parseInt(result[2], 16);
  var b = parseInt(result[3], 16);
  return [r, g, b];
}

var HexagonIdLayer =
/*#__PURE__*/
function (_Layer) {
  (0, _inherits2["default"])(HexagonIdLayer, _Layer);

  function HexagonIdLayer(props) {
    var _this;

    (0, _classCallCheck2["default"])(this, HexagonIdLayer);
    _this = (0, _possibleConstructorReturn2["default"])(this, (0, _getPrototypeOf2["default"])(HexagonIdLayer).call(this, props));

    _this.registerVisConfig(HexagonIdVisConfigs);

    _this.getHexId = (0, _lodash["default"])(hexIdAccessor, hexIdResolver);
    return _this;
  }

  (0, _createClass2["default"])(HexagonIdLayer, [{
    key: "getDefaultLayerConfig",
    value: function getDefaultLayerConfig() {
      var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
      return _objectSpread({}, (0, _get2["default"])((0, _getPrototypeOf2["default"])(HexagonIdLayer.prototype), "getDefaultLayerConfig", this).call(this, props), {
        // add height visual channel
        coverageField: null,
        coverageDomain: [0, 1],
        coverageScale: 'linear'
      });
    } // TODO: fix complexity

    /* eslint-disable complexity */

  }, {
    key: "formatLayerData",
    value: function formatLayerData(_, allData, filteredIndex, oldLayerData) {
      var _this2 = this;

      var opt = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : {};
      var _this$config = this.config,
          colorScale = _this$config.colorScale,
          colorDomain = _this$config.colorDomain,
          colorField = _this$config.colorField,
          color = _this$config.color,
          columns = _this$config.columns,
          sizeField = _this$config.sizeField,
          sizeScale = _this$config.sizeScale,
          sizeDomain = _this$config.sizeDomain,
          coverageField = _this$config.coverageField,
          coverageScale = _this$config.coverageScale,
          coverageDomain = _this$config.coverageDomain,
          _this$config$visConfi = _this$config.visConfig,
          sizeRange = _this$config$visConfi.sizeRange,
          colorRange = _this$config$visConfi.colorRange,
          coverageRange = _this$config$visConfi.coverageRange; // color

      var cScale = colorField && this.getVisChannelScale(colorScale, colorDomain, colorRange.colors.map(function (c) {
        return hexToRgb(c);
      })); // height

      var sScale = sizeField && this.getVisChannelScale(sizeScale, sizeDomain, sizeRange, 0); // coverage

      var coScale = coverageField && this.getVisChannelScale(coverageScale, coverageDomain, coverageRange, 0);
      var getHexId = this.getHexId(columns);

      if (!oldLayerData || oldLayerData.getHexId !== getHexId) {
        this.updateLayerMeta(allData, getHexId);
      }

      var data;

      if (oldLayerData && oldLayerData.data && opt.sameData && oldLayerData.getHexId === getHexId) {
        data = oldLayerData.data;
      } else {
        data = filteredIndex.reduce(function (accu, index, i) {
          var id = getHexId(allData[index]);
          var centroid = _this2.dataToFeature.centroids[index];

          if (centroid) {
            accu.push({
              // keep a reference to the original data index
              index: i,
              data: allData[index],
              id: id,
              centroid: centroid
            });
          }

          return accu;
        }, []);
      }

      var getElevation = sScale ? function (d) {
        return _this2.getEncodedChannelValue(sScale, d.data, sizeField, 0);
      } : 0;
      var getColor = cScale ? function (d) {
        return _this2.getEncodedChannelValue(cScale, d.data, colorField);
      } : color;
      var getCoverage = coScale ? function (d) {
        return _this2.getEncodedChannelValue(coScale, d.data, coverageField, 0);
      } : 1; // const layerData = {

      return {
        data: data,
        getElevation: getElevation,
        getColor: getColor,
        getHexId: getHexId,
        getCoverage: getCoverage,
        hexagonVertices: this.dataToFeature.hexagonVertices,
        hexagonCenter: this.dataToFeature.hexagonCenter
      };
    }
    /* eslint-enable complexity */

  }, {
    key: "updateLayerMeta",
    value: function updateLayerMeta(allData, getHexId) {
      var hexagonVertices;
      var hexagonCenter;
      var centroids = {};
      allData.forEach(function (d, index) {
        var id = getHexId(d);

        if (!(0, _h3Utils.h3IsValid)(id)) {
          return;
        } // find hexagonVertices
        // only need 1 instance of hexagonVertices


        if (!hexagonVertices) {
          hexagonVertices = (0, _h3Utils.getVertices)({
            id: id
          });
          hexagonCenter = (0, _h3Utils.getCentroid)({
            id: id
          });
        } // save a reference of centroids to dataToFeature
        // so we don't have to re calculate it again


        centroids[index] = (0, _h3Utils.getCentroid)({
          id: id
        });
      });
      var bounds = this.getPointsBounds(Object.values(centroids), function (d) {
        return d;
      });
      this.dataToFeature = {
        hexagonVertices: hexagonVertices,
        hexagonCenter: hexagonCenter,
        centroids: centroids
      };
      this.updateMeta({
        bounds: bounds
      });
    }
  }, {
    key: "renderLayer",
    value: function renderLayer(_ref3) {
      var data = _ref3.data,
          idx = _ref3.idx,
          layerInteraction = _ref3.layerInteraction,
          objectHovered = _ref3.objectHovered,
          mapState = _ref3.mapState,
          interactionConfig = _ref3.interactionConfig;
      var zoomFactor = this.getZoomFactor(mapState);
      var eleZoomFactor = this.getElevationZoomFactor(mapState);
      var config = this.config;
      var visConfig = config.visConfig;
      var h3HexagonLayerTriggers = {
        getColor: {
          color: config.color,
          colorField: config.colorField,
          colorRange: config.visConfig.colorRange,
          colorScale: config.colorScale
        },
        getElevation: {
          sizeField: config.sizeField,
          sizeRange: config.visConfig.sizeRange
        }
      };
      var columnLayerTriggers = {
        getCoverage: {
          coverageField: config.coverageField,
          coverageRange: config.visConfig.coverageRange
        }
      };
      return [new _deck.H3HexagonLayer(_objectSpread({}, layerInteraction, {}, data, {
        id: this.id,
        idx: idx,
        pickable: true,
        getHexagon: function getHexagon(x) {
          return x.id;
        },
        // coverage
        coverage: config.coverageField ? 1 : visConfig.coverage,
        // parameters
        parameters: {
          depthTest: Boolean(config.sizeField || mapState.dragRotate)
        },
        // highlight
        autoHighlight: Boolean(config.sizeField),
        highlightColor: _defaultSettings.HIGHLIGH_COLOR_3D,
        // elevation
        extruded: Boolean(config.sizeField),
        elevationScale: visConfig.elevationScale * eleZoomFactor,
        // color
        opacity: visConfig.opacity,
        // render
        updateTriggers: h3HexagonLayerTriggers,
        _subLayerProps: {
          'hexagon-cell': {
            type: _enhancedColumnLayer["default"],
            getCoverage: data.getCoverage,
            updateTriggers: columnLayerTriggers
          }
        }
      }))].concat((0, _toConsumableArray2["default"])(this.isLayerHovered(objectHovered) && !config.sizeField ? [new _deck.GeoJsonLayer({
        id: "".concat(this.id, "-hovered"),
        data: [(0, _h3Utils.idToPolygonGeo)(objectHovered)],
        getLineColor: config.highlightColor,
        lineWidthScale: 8 * zoomFactor
      })] : []));
    }
  }, {
    key: "type",
    get: function get() {
      return 'hexagonId';
    }
  }, {
    key: "name",
    get: function get() {
      return 'H3';
    }
  }, {
    key: "requiredLayerColumns",
    get: function get() {
      return hexIdRequiredColumns;
    }
  }, {
    key: "layerIcon",
    get: function get() {
      // use hexagon layer icon for now
      return _h3HexagonLayerIcon["default"];
    }
  }, {
    key: "visualChannels",
    get: function get() {
      return _objectSpread({}, (0, _get2["default"])((0, _getPrototypeOf2["default"])(HexagonIdLayer.prototype), "visualChannels", this), {
        size: _objectSpread({}, (0, _get2["default"])((0, _getPrototypeOf2["default"])(HexagonIdLayer.prototype), "visualChannels", this).size, {
          property: 'height'
        }),
        coverage: {
          property: 'coverage',
          field: 'coverageField',
          scale: 'coverageScale',
          domain: 'coverageDomain',
          range: 'coverageRange',
          key: 'coverage',
          channelScaleType: _defaultSettings.CHANNEL_SCALES.radius
        }
      });
    }
  }], [{
    key: "findDefaultLayerProps",
    value: function findDefaultLayerProps(_ref4) {
      var _ref4$fields = _ref4.fields,
          fields = _ref4$fields === void 0 ? [] : _ref4$fields;
      var foundColumns = this.findDefaultColumnField(HEXAGON_ID_FIELDS, fields);

      if (!foundColumns || !foundColumns.length) {
        return {
          props: []
        };
      }

      return {
        props: foundColumns.map(function (columns) {
          return {
            isVisible: true,
            label: 'H3 Hexagon',
            columns: columns
          };
        })
      };
    }
  }]);
  return HexagonIdLayer;
}(_baseLayer["default"]);

exports["default"] = HexagonIdLayer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYXllcnMvaDMtaGV4YWdvbi1sYXllci9oMy1oZXhhZ29uLWxheWVyLmpzIl0sIm5hbWVzIjpbIkhFWEFHT05fSURfRklFTERTIiwiaGV4X2lkIiwiaGV4SWRSZXF1aXJlZENvbHVtbnMiLCJoZXhJZEFjY2Vzc29yIiwiZCIsImZpZWxkSWR4IiwiaGV4SWRSZXNvbHZlciIsIkhleGFnb25JZFZpc0NvbmZpZ3MiLCJvcGFjaXR5IiwiY29sb3JSYW5nZSIsImNvdmVyYWdlIiwic2l6ZVJhbmdlIiwiY292ZXJhZ2VSYW5nZSIsImVsZXZhdGlvblNjYWxlIiwiaGV4VG9SZ2IiLCJoZXgiLCJyZXN1bHQiLCJleGVjIiwiciIsInBhcnNlSW50IiwiZyIsImIiLCJIZXhhZ29uSWRMYXllciIsInByb3BzIiwicmVnaXN0ZXJWaXNDb25maWciLCJnZXRIZXhJZCIsImNvdmVyYWdlRmllbGQiLCJjb3ZlcmFnZURvbWFpbiIsImNvdmVyYWdlU2NhbGUiLCJfIiwiYWxsRGF0YSIsImZpbHRlcmVkSW5kZXgiLCJvbGRMYXllckRhdGEiLCJvcHQiLCJjb25maWciLCJjb2xvclNjYWxlIiwiY29sb3JEb21haW4iLCJjb2xvckZpZWxkIiwiY29sb3IiLCJjb2x1bW5zIiwic2l6ZUZpZWxkIiwic2l6ZVNjYWxlIiwic2l6ZURvbWFpbiIsInZpc0NvbmZpZyIsImNTY2FsZSIsImdldFZpc0NoYW5uZWxTY2FsZSIsImNvbG9ycyIsIm1hcCIsImMiLCJzU2NhbGUiLCJjb1NjYWxlIiwidXBkYXRlTGF5ZXJNZXRhIiwiZGF0YSIsInNhbWVEYXRhIiwicmVkdWNlIiwiYWNjdSIsImluZGV4IiwiaSIsImlkIiwiY2VudHJvaWQiLCJkYXRhVG9GZWF0dXJlIiwiY2VudHJvaWRzIiwicHVzaCIsImdldEVsZXZhdGlvbiIsImdldEVuY29kZWRDaGFubmVsVmFsdWUiLCJnZXRDb2xvciIsImdldENvdmVyYWdlIiwiaGV4YWdvblZlcnRpY2VzIiwiaGV4YWdvbkNlbnRlciIsImZvckVhY2giLCJib3VuZHMiLCJnZXRQb2ludHNCb3VuZHMiLCJPYmplY3QiLCJ2YWx1ZXMiLCJ1cGRhdGVNZXRhIiwiaWR4IiwibGF5ZXJJbnRlcmFjdGlvbiIsIm9iamVjdEhvdmVyZWQiLCJtYXBTdGF0ZSIsImludGVyYWN0aW9uQ29uZmlnIiwiem9vbUZhY3RvciIsImdldFpvb21GYWN0b3IiLCJlbGVab29tRmFjdG9yIiwiZ2V0RWxldmF0aW9uWm9vbUZhY3RvciIsImgzSGV4YWdvbkxheWVyVHJpZ2dlcnMiLCJjb2x1bW5MYXllclRyaWdnZXJzIiwiSDNIZXhhZ29uTGF5ZXIiLCJwaWNrYWJsZSIsImdldEhleGFnb24iLCJ4IiwicGFyYW1ldGVycyIsImRlcHRoVGVzdCIsIkJvb2xlYW4iLCJkcmFnUm90YXRlIiwiYXV0b0hpZ2hsaWdodCIsImhpZ2hsaWdodENvbG9yIiwiSElHSExJR0hfQ09MT1JfM0QiLCJleHRydWRlZCIsInVwZGF0ZVRyaWdnZXJzIiwiX3N1YkxheWVyUHJvcHMiLCJ0eXBlIiwiRW5oYW5jZWRDb2x1bW5MYXllciIsImlzTGF5ZXJIb3ZlcmVkIiwiR2VvSnNvbkxheWVyIiwiZ2V0TGluZUNvbG9yIiwibGluZVdpZHRoU2NhbGUiLCJIM0hleGFnb25MYXllckljb24iLCJzaXplIiwicHJvcGVydHkiLCJmaWVsZCIsInNjYWxlIiwiZG9tYWluIiwicmFuZ2UiLCJrZXkiLCJjaGFubmVsU2NhbGVUeXBlIiwiQ0hBTk5FTF9TQ0FMRVMiLCJyYWRpdXMiLCJmaWVsZHMiLCJmb3VuZENvbHVtbnMiLCJmaW5kRGVmYXVsdENvbHVtbkZpZWxkIiwibGVuZ3RoIiwiaXNWaXNpYmxlIiwibGFiZWwiLCJMYXllciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW9CQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRU8sSUFBTUEsaUJBQWlCLEdBQUc7QUFDL0JDLEVBQUFBLE1BQU0sRUFBRSxDQUFDLFFBQUQsRUFBVyxZ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TCxDQUE0QnZILGlCQUE1QixFQUErQ3FILE1BQS9DLENBQXJCOztBQUNBLFVBQUksQ0FBQ0MsWUFBRCxJQUFpQixDQUFDQSxZQUFZLENBQUNFLE1BQW5DLEVBQTJDO0FBQ3pDLGVBQU87QUFBQ2pHLFVBQUFBLEtBQUssRUFBRTtBQUFSLFNBQVA7QUFDRDs7QUFFRCxhQUFPO0FBQ0xBLFFBQUFBLEtBQUssRUFBRStGLFlBQVksQ0FBQ3ZFLEdBQWIsQ0FBaUIsVUFBQVIsT0FBTztBQUFBLGlCQUFLO0FBQ2xDa0YsWUFBQUEsU0FBUyxFQUFFLElBRHVCO0FBRWxDQyxZQUFBQSxLQUFLLEVBQUUsWUFGMkI7QUFHbENuRixZQUFBQSxPQUFPLEVBQVBBO0FBSGtDLFdBQUw7QUFBQSxTQUF4QjtBQURGLE9BQVA7QUFPRDs7O0VBeER5Q29GLHFCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDE5IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cblxuaW1wb3J0IG1lbW9pemUgZnJvbSAnbG9kYXNoLm1lbW9pemUnO1xuXG5pbXBvcnQgTGF5ZXIgZnJvbSAnLi4vYmFzZS1sYXllcic7XG5pbXBvcnQge0dlb0pzb25MYXllciwgSDNIZXhhZ29uTGF5ZXJ9IGZyb20gJ2RlY2suZ2wnO1xuaW1wb3J0IEVuaGFuY2VkQ29sdW1uTGF5ZXIgZnJvbSAnZGVja2dsLWxheWVycy9jb2x1bW4tbGF5ZXIvZW5oYW5jZWQtY29sdW1uLWxheWVyJztcbmltcG9ydCB7Z2V0VmVydGljZXMsIGdldENlbnRyb2lkLCBpZFRvUG9seWdvbkdlbywgaDNJc1ZhbGlkfSBmcm9tICcuL2gzLXV0aWxzJztcbmltcG9ydCBIM0hleGFnb25MYXllckljb24gZnJvbSAnLi9oMy1oZXhhZ29uLWxheWVyLWljb24nO1xuaW1wb3J0IHtDSEFOTkVMX1NDQUxFUywgSElHSExJR0hfQ09MT1JfM0R9IGZyb20gJ2NvbnN0YW50cy9kZWZhdWx0LXNldHRpbmdzJztcblxuZXhwb3J0IGNvbnN0IEhFWEFHT05fSURfRklFTERTID0ge1xuICBoZXhfaWQ6IFsnaGV4X2lkJywgJ2hleGFnb25faWQnLCAnaDNfaWQnXVxufTtcblxuZXhwb3J0IGNvbnN0IGhleElkUmVxdWlyZWRDb2x1bW5zID0gWydoZXhfaWQnXTtcbmV4cG9ydCBjb25zdCBoZXhJZEFjY2Vzc29yID0gKHtoZXhfaWR9KSA9PiBkID0+IGRbaGV4X2lkLmZpZWxkSWR4XTtcbmV4cG9ydCBjb25zdCBoZXhJZFJlc29sdmVyID0gKHtoZXhfaWR9KSA9PiBoZXhfaWQuZmllbGRJZHg7XG5cbmV4cG9ydCBjb25zdCBIZXhhZ29uSWRWaXNDb25maWdzID0ge1xuICBvcGFjaXR5OiAnb3BhY2l0eScsXG4gIGNvbG9yUmFuZ2U6ICdjb2xvclJhbmdlJyxcbiAgY292ZXJhZ2U6ICdjb3ZlcmFnZScsXG4gIHNpemVSYW5nZTogJ2VsZXZhdGlvblJhbmdlJyxcbiAgY292ZXJhZ2VSYW5nZTogJ2NvdmVyYWdlUmFuZ2UnLFxuICBlbGV2YXRpb25TY2FsZTogJ2VsZXZhdGlvblNjYWxlJ1xufTtcblxuZnVuY3Rpb24gaGV4VG9SZ2IoaGV4KSB7XG4gIGNvbnN0IHJlc3VsdCA9IC9eIz8oW2EtZlxcZF17Mn0pKFthLWZcXGRdezJ9KShbYS1mXFxkXXsyfSkkL2kuZXhlYyhoZXgpO1xuXG4gIGNvbnN0IHIgPSBwYXJzZUludChyZXN1bHRbMV0sIDE2KTtcbiAgY29uc3QgZyA9IHBhcnNlSW50KHJlc3VsdFsyXSwgMTYpO1xuICBjb25zdCBiID0gcGFyc2VJbnQocmVzdWx0WzNdLCAxNik7XG5cbiAgcmV0dXJuIFtyLCBnLCBiXTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSGV4YWdvbklkTGF5ZXIgZXh0ZW5kcyBMYXllciB7XG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuICAgIHRoaXMucmVnaXN0ZXJWaXNDb25maWcoSGV4YWdvbklkVmlzQ29uZmlncyk7XG4gICAgdGhpcy5nZXRIZXhJZCA9IG1lbW9pemUoaGV4SWRBY2Nlc3NvciwgaGV4SWRSZXNvbHZlcik7XG4gIH1cblxuICBnZXQgdHlwZSgpIHtcbiAgICByZXR1cm4gJ2hleGFnb25JZCc7XG4gIH1cblxuICBnZXQgbmFtZSgpIHtcbiAgICByZXR1cm4gJ0gzJztcbiAgfVxuXG4gIGdldCByZXF1aXJlZExheWVyQ29sdW1ucygpIHtcbiAgICByZXR1cm4gaGV4SWRSZXF1aXJlZENvbHVtbnM7XG4gIH1cblxuICBnZXQgbGF5ZXJJY29uKCkge1xuICAgIC8vIHVzZSBoZXhhZ29uIGxheWVyIGljb24gZm9yIG5vd1xuICAgIHJldHVybiBIM0hleGFnb25MYXllckljb247XG4gIH1cblxuICBnZXQgdmlzdWFsQ2hhbm5lbHMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnN1cGVyLnZpc3VhbENoYW5uZWxzLFxuICAgICAgc2l6ZToge1xuICAgICAgICAuLi5zdXBlci52aXN1YWxDaGFubmVscy5zaXplLFxuICAgICAgICBwcm9wZXJ0eTogJ2hlaWdodCdcbiAgICAgIH0sXG4gICAgICBjb3ZlcmFnZToge1xuICAgICAgICBwcm9wZXJ0eTogJ2NvdmVyYWdlJyxcbiAgICAgICAgZmllbGQ6ICdjb3ZlcmFnZUZpZWxkJyxcbiAgICAgICAgc2NhbGU6ICdjb3ZlcmFnZVNjYWxlJyxcbiAgICAgICAgZG9tYWluOiAnY292ZXJhZ2VEb21haW4nLFxuICAgICAgICByYW5nZTogJ2NvdmVyYWdlUmFuZ2UnLFxuICAgICAgICBrZXk6ICdjb3ZlcmFnZScsXG4gICAgICAgIGNoYW5uZWxTY2FsZVR5cGU6IENIQU5ORUxfU0NBTEVTLnJhZGl1c1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBzdGF0aWMgZmluZERlZmF1bHRMYXllclByb3BzKHtmaWVsZHMgPSBbXX0pIHtcbiAgICBjb25zdCBmb3VuZENvbHVtbnMgPSB0aGlzLmZpbmREZWZhdWx0Q29sdW1uRmllbGQoSEVYQUdPTl9JRF9GSUVMRFMsIGZpZWxkcyk7XG4gICAgaWYgKCFmb3VuZENvbHVtbnMgfHwgIWZvdW5kQ29sdW1ucy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiB7cHJvcHM6IFtdfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgcHJvcHM6IGZvdW5kQ29sdW1ucy5tYXAoY29sdW1ucyA9PiAoe1xuICAgICAgICBpc1Zpc2libGU6IHRydWUsXG4gICAgICAgIGxhYmVsOiAnSDMgSGV4YWdvbicsXG4gICAgICAgIGNvbHVtbnNcbiAgICAgIH0pKVxuICAgIH07XG4gIH1cblxuICBnZXREZWZhdWx0TGF5ZXJDb25maWcocHJvcHMgPSB7fSkge1xuICAgIHJldHVybiB7XG4gICAgICAuLi5zdXBlci5nZXREZWZhdWx0TGF5ZXJDb25maWcocHJvcHMpLFxuXG4gICAgICAvLyBhZGQgaGVpZ2h0IHZpc3VhbCBjaGFubmVsXG4gICAgICBjb3ZlcmFnZUZpZWxkOiBudWxsLFxuICAgICAgY292ZXJhZ2VEb21haW46IFswLCAxXSxcbiAgICAgIGNvdmVyYWdlU2NhbGU6ICdsaW5lYXInXG4gICAgfTtcbiAgfVxuXG4gIC8vIFRPRE86IGZpeCBjb21wbGV4aXR5XG4gIC8qIGVzbGludC1kaXNhYmxlIGNvbXBsZXhpdHkgKi9cbiAgZm9ybWF0TGF5ZXJEYXRhKF8sIGFsbERhdGEsIGZpbHRlcmVkSW5kZXgsIG9sZExheWVyRGF0YSwgb3B0ID0ge30pIHtcbiAgICBjb25zdCB7XG4gICAgICBjb2xvclNjYWxlLFxuICAgICAgY29sb3JEb21haW4sXG4gICAgICBjb2xvckZpZWxkLFxuICAgICAgY29sb3IsXG4gICAgICBjb2x1bW5zLFxuICAgICAgc2l6ZUZpZWxkLFxuICAgICAgc2l6ZVNjYWxlLFxuICAgICAgc2l6ZURvbWFpbixcbiAgICAgIGNvdmVyYWdlRmllbGQsXG4gICAgICBjb3ZlcmFnZVNjYWxlLFxuICAgICAgY292ZXJhZ2VEb21haW4sXG4gICAgICB2aXNDb25maWc6IHtzaXplUmFuZ2UsIGNvbG9yUmFuZ2UsIGNvdmVyYWdlUmFuZ2V9XG4gICAgfSA9IHRoaXMuY29uZmlnO1xuXG4gICAgLy8gY29sb3JcbiAgICBjb25zdCBjU2NhbGUgPVxuICAgICAgY29sb3JGaWVsZCAmJlxuICAgICAgdGhpcy5nZXRWaXNDaGFubmVsU2NhbGUoXG4gICAgICAgIGNvbG9yU2NhbGUsXG4gICAgICAgIGNvbG9yRG9tYWluLFxuICAgICAgICBjb2xvclJhbmdlLmNvbG9ycy5tYXAoYyA9PiBoZXhUb1JnYihjKSlcbiAgICAgICk7XG5cbiAgICAvLyBoZWlnaHRcbiAgICBjb25zdCBzU2NhbGUgPVxuICAgICAgc2l6ZUZpZWxkICYmIHRoaXMuZ2V0VmlzQ2hhbm5lbFNjYWxlKHNpemVTY2FsZSwgc2l6ZURvbWFpbiwgc2l6ZVJhbmdlLCAwKTtcblxuICAgIC8vIGNvdmVyYWdlXG4gICAgY29uc3QgY29TY2FsZSA9XG4gICAgICBjb3ZlcmFnZUZpZWxkICYmXG4gICAgICB0aGlzLmdldFZpc0NoYW5uZWxTY2FsZShjb3ZlcmFnZVNjYWxlLCBjb3ZlcmFnZURvbWFpbiwgY292ZXJhZ2VSYW5nZSwgMCk7XG5cbiAgICBjb25zdCBnZXRIZXhJZCA9IHRoaXMuZ2V0SGV4SWQoY29sdW1ucyk7XG5cbiAgICBpZiAoIW9sZExheWVyRGF0YSB8fCBvbGRMYXllckRhdGEuZ2V0SGV4SWQgIT09IGdldEhleElkKSB7XG4gICAgICB0aGlzLnVwZGF0ZUxheWVyTWV0YShhbGxEYXRhLCBnZXRIZXhJZCk7XG4gICAgfVxuXG4gICAgbGV0IGRhdGE7XG4gICAgaWYgKFxuICAgICAgb2xkTGF5ZXJEYXRhICYmXG4gICAgICBvbGRMYXllckRhdGEuZGF0YSAmJlxuICAgICAgb3B0LnNhbWVEYXRhICYmXG4gICAgICBvbGRMYXllckRhdGEuZ2V0SGV4SWQgPT09IGdldEhleElkXG4gICAgKSB7XG4gICAgICBkYXRhID0gb2xkTGF5ZXJEYXRhLmRhdGE7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRhdGEgPSBmaWx0ZXJlZEluZGV4LnJlZHVjZSgoYWNjdSwgaW5kZXgsIGkpID0+IHtcbiAgICAgICAgY29uc3QgaWQgPSBnZXRIZXhJZChhbGxEYXRhW2luZGV4XSk7XG4gICAgICAgIGNvbnN0IGNlbnRyb2lkID0gdGhpcy5kYXRhVG9GZWF0dXJlLmNlbnRyb2lkc1tpbmRleF07XG5cbiAgICAgICAgaWYgKGNlbnRyb2lkKSB7XG4gICAgICAgICAgYWNjdS5wdXNoKHtcbiAgICAgICAgICAgIC8vIGtlZXAgYSByZWZlcmVuY2UgdG8gdGhlIG9yaWdpbmFsIGRhdGEgaW5kZXhcbiAgICAgICAgICAgIGluZGV4OiBpLFxuICAgICAgICAgICAgZGF0YTogYWxsRGF0YVtpbmRleF0sXG4gICAgICAgICAgICBpZCxcbiAgICAgICAgICAgIGNlbnRyb2lkXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYWNjdTtcbiAgICAgIH0sIFtdKTtcbiAgICB9XG5cbiAgICBjb25zdCBnZXRFbGV2YXRpb24gPSBzU2NhbGVcbiAgICAgID8gZCA9PiB0aGlzLmdldEVuY29kZWRDaGFubmVsVmFsdWUoc1NjYWxlLCBkLmRhdGEsIHNpemVGaWVsZCwgMClcbiAgICAgIDogMDtcblxuICAgIGNvbnN0IGdldENvbG9yID0gY1NjYWxlXG4gICAgICA/IGQgPT4gdGhpcy5nZXRFbmNvZGVkQ2hhbm5lbFZhbHVlKGNTY2FsZSwgZC5kYXRhLCBjb2xvckZpZWxkKVxuICAgICAgOiBjb2xvcjtcblxuICAgIGNvbnN0IGdldENvdmVyYWdlID0gY29TY2FsZVxuICAgICAgPyBkID0+IHRoaXMuZ2V0RW5jb2RlZENoYW5uZWxWYWx1ZShjb1NjYWxlLCBkLmRhdGEsIGNvdmVyYWdlRmllbGQsIDApXG4gICAgICA6IDE7XG5cbiAgICAvLyBjb25zdCBsYXllckRhdGEgPSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGRhdGEsXG4gICAgICBnZXRFbGV2YXRpb24sXG4gICAgICBnZXRDb2xvcixcbiAgICAgIGdldEhleElkLFxuICAgICAgZ2V0Q292ZXJhZ2UsXG4gICAgICBoZXhhZ29uVmVydGljZXM6IHRoaXMuZGF0YVRvRmVhdHVyZS5oZXhhZ29uVmVydGljZXMsXG4gICAgICBoZXhhZ29uQ2VudGVyOiB0aGlzLmRhdGFUb0ZlYXR1cmUuaGV4YWdvbkNlbnRlclxuICAgIH07XG4gIH1cbiAgLyogZXNsaW50LWVuYWJsZSBjb21wbGV4aXR5ICovXG5cbiAgdXBkYXRlTGF5ZXJNZXRhKGFsbERhdGEsIGdldEhleElkKSB7XG4gICAgbGV0IGhleGFnb25WZXJ0aWNlcztcbiAgICBsZXQgaGV4YWdvbkNlbnRlcjtcbiAgICBjb25zdCBjZW50cm9pZHMgPSB7fTtcblxuICAgIGFsbERhdGEuZm9yRWFjaCgoZCwgaW5kZXgpID0+IHtcbiAgICAgIGNvbnN0IGlkID0gZ2V0SGV4SWQoZCk7XG4gICAgICBpZiAoIWgzSXNWYWxpZChpZCkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgLy8gZmluZCBoZXhhZ29uVmVydGljZXNcbiAgICAgIC8vIG9ubHkgbmVlZCAxIGluc3RhbmNlIG9mIGhleGFnb25WZXJ0aWNlc1xuICAgICAgaWYgKCFoZXhhZ29uVmVydGljZXMpIHtcbiAgICAgICAgaGV4YWdvblZlcnRpY2VzID0gZ2V0VmVydGljZXMoe2lkfSk7XG4gICAgICAgIGhleGFnb25DZW50ZXIgPSBnZXRDZW50cm9pZCh7aWR9KTtcbiAgICAgIH1cblxuICAgICAgLy8gc2F2ZSBhIHJlZmVyZW5jZSBvZiBjZW50cm9pZHMgdG8gZGF0YVRvRmVhdHVyZVxuICAgICAgLy8gc28gd2UgZG9uJ3QgaGF2ZSB0byByZSBjYWxjdWxhdGUgaXQgYWdhaW5cbiAgICAgIGNlbnRyb2lkc1tpbmRleF0gPSBnZXRDZW50cm9pZCh7aWR9KTtcbiAgICB9KTtcblxuICAgIGNvbnN0IGJvdW5kcyA9IHRoaXMuZ2V0UG9pbnRzQm91bmRzKE9iamVjdC52YWx1ZXMoY2VudHJvaWRzKSwgZCA9PiBkKTtcbiAgICB0aGlzLmRhdGFUb0ZlYXR1cmUgPSB7aGV4YWdvblZlcnRpY2VzLCBoZXhhZ29uQ2VudGVyLCBjZW50cm9pZHN9O1xuICAgIHRoaXMudXBkYXRlTWV0YSh7Ym91bmRzfSk7XG4gIH1cblxuICByZW5kZXJMYXllcih7XG4gICAgZGF0YSxcbiAgICBpZHgsXG4gICAgbGF5ZXJJbnRlcmFjdGlvbixcbiAgICBvYmplY3RIb3ZlcmVkLFxuICAgIG1hcFN0YXRlLFxuICAgIGludGVyYWN0aW9uQ29uZmlnXG4gIH0pIHtcbiAgICBjb25zdCB6b29tRmFjdG9yID0gdGhpcy5nZXRab29tRmFjdG9yKG1hcFN0YXRlKTtcbiAgICBjb25zdCBlbGVab29tRmFjdG9yID0gdGhpcy5nZXRFbGV2YXRpb25ab29tRmFjdG9yKG1hcFN0YXRlKTtcbiAgICBjb25zdCB7Y29uZmlnfSA9IHRoaXM7XG4gICAgY29uc3Qge3Zpc0NvbmZpZ30gPSBjb25maWc7XG5cbiAgICBjb25zdCBoM0hleGFnb25MYXllclRyaWdnZXJzID0ge1xuICAgICAgZ2V0Q29sb3I6IHtcbiAgICAgICAgY29sb3I6IGNvbmZpZy5jb2xvcixcbiAgICAgICAgY29sb3JGaWVsZDogY29uZmlnLmNvbG9yRmllbGQsXG4gICAgICAgIGNvbG9yUmFuZ2U6IGNvbmZpZy52aXNDb25maWcuY29sb3JSYW5nZSxcbiAgICAgICAgY29sb3JTY2FsZTogY29uZmlnLmNvbG9yU2NhbGVcbiAgICAgIH0sXG4gICAgICBnZXRFbGV2YXRpb246IHtcbiAgICAgICAgc2l6ZUZpZWxkOiBjb25maWcuc2l6ZUZpZWxkLFxuICAgICAgICBzaXplUmFuZ2U6IGNvbmZpZy52aXNDb25maWcuc2l6ZVJhbmdlXG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IGNvbHVtbkxheWVyVHJpZ2dlcnMgPSB7XG4gICAgICBnZXRDb3ZlcmFnZToge1xuICAgICAgICBjb3ZlcmFnZUZpZWxkOiBjb25maWcuY292ZXJhZ2VGaWVsZCxcbiAgICAgICAgY292ZXJhZ2VSYW5nZTogY29uZmlnLnZpc0NvbmZpZy5jb3ZlcmFnZVJhbmdlXG4gICAgICB9XG4gICAgfTtcblxuICAgIHJldHVybiBbXG4gICAgICBuZXcgSDNIZXhhZ29uTGF5ZXIoe1xuICAgICAgICAuLi5sYXllckludGVyYWN0aW9uLFxuICAgICAgICAuLi5kYXRhLFxuICAgICAgICBpZDogdGhpcy5pZCxcbiAgICAgICAgaWR4LFxuICAgICAgICBwaWNrYWJsZTogdHJ1ZSxcbiAgICAgICAgZ2V0SGV4YWdvbjogeCA9PiB4LmlkLFxuXG4gICAgICAgIC8vIGNvdmVyYWdlXG4gICAgICAgIGNvdmVyYWdlOiBjb25maWcuY292ZXJhZ2VGaWVsZCA/IDEgOiB2aXNDb25maWcuY292ZXJhZ2UsXG5cbiAgICAgICAgLy8gcGFyYW1ldGVyc1xuICAgICAgICBwYXJhbWV0ZXJzOiB7ZGVwdGhUZXN0OiBCb29sZWFuKGNvbmZpZy5zaXplRmllbGQgfHwgbWFwU3RhdGUuZHJhZ1JvdGF0ZSl9LFxuXG4gICAgICAgIC8vIGhpZ2hsaWdodFxuICAgICAgICBhdXRvSGlnaGxpZ2h0OiBCb29sZWFuKGNvbmZpZy5zaXplRmllbGQpLFxuICAgICAgICBoaWdobGlnaHRDb2xvcjogSElHSExJR0hfQ09MT1JfM0QsXG5cbiAgICAgICAgLy8gZWxldmF0aW9uXG4gICAgICAgIGV4dHJ1ZGVkOiBCb29sZWFuKGNvbmZpZy5zaXplRmllbGQpLFxuICAgICAgICBlbGV2YXRpb25TY2FsZTogdmlzQ29uZmlnLmVsZXZhdGlvblNjYWxlICogZWxlWm9vbUZhY3RvcixcblxuICAgICAgICAvLyBjb2xvclxuICAgICAgICBvcGFjaXR5OiB2aXNDb25maWcub3BhY2l0eSxcblxuICAgICAgICAvLyByZW5kZXJcbiAgICAgICAgdXBkYXRlVHJpZ2dlcnM6IGgzSGV4YWdvbkxheWVyVHJpZ2dlcnMsXG4gICAgICAgIF9zdWJMYXllclByb3BzOiB7XG4gICAgICAgICAgJ2hleGFnb24tY2VsbCc6IHtcbiAgICAgICAgICAgIHR5cGU6IEVuaGFuY2VkQ29sdW1uTGF5ZXIsXG4gICAgICAgICAgICBnZXRDb3ZlcmFnZTogZGF0YS5nZXRDb3ZlcmFnZSxcbiAgICAgICAgICAgIHVwZGF0ZVRyaWdnZXJzOiBjb2x1bW5MYXllclRyaWdnZXJzXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KSxcbiAgICAgIC4uLih0aGlzLmlzTGF5ZXJIb3ZlcmVkKG9iamVjdEhvdmVyZWQpICYmICFjb25maWcuc2l6ZUZpZWxkXG4gICAgICAgID8gW1xuICAgICAgICAgICAgbmV3IEdlb0pzb25MYXllcih7XG4gICAgICAgICAgICAgIGlkOiBgJHt0aGlzLmlkfS1ob3ZlcmVkYCxcbiAgICAgICAgICAgICAgZGF0YTogW2lkVG9Qb2x5Z29uR2VvKG9iamVjdEhvdmVyZWQpXSxcbiAgICAgICAgICAgICAgZ2V0TGluZUNvbG9yOiBjb25maWcuaGlnaGxpZ2h0Q29sb3IsXG4gICAgICAgICAgICAgIGxpbmVXaWR0aFNjYWxlOiA4ICogem9vbUZhY3RvclxuICAgICAgICAgICAgfSlcbiAgICAgICAgICBdXG4gICAgICAgIDogW10pXG4gICAgXTtcbiAgfVxufVxuIl19