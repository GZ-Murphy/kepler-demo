"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ContainerFactory = ContainerFactory;
exports.injectComponents = injectComponents;
exports["default"] = exports.appInjector = exports.errorMsg = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _reactRedux = require("react-redux");

var _lodash = _interopRequireDefault(require("lodash.memoize"));

var _window = require("global/window");

var _injector = require("./injector");

var _keplerGl = _interopRequireDefault(require("./kepler-gl"));

var _actionWrapper = require("../actions/action-wrapper");

var _identityActions = require("../actions/identity-actions");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var errorMsg = {
  noState: "kepler.gl state doesnt exist. " + "You might forget to mount keplerGlReducer in your root reducer." + "If it is not mounted as state.keplerGl by default, you need to provide getState as a prop",
  wrongType: function wrongType(type) {
    return "injectComponents takes an array of factories replacement pairs as input, " + "".concat(type, " is provided");
  },
  wrongPairType: "injectComponents takes an array of factories replacement pairs as input, " + "each pair be a array as [originalFactory, replacement]"
};
exports.errorMsg = errorMsg;
ContainerFactory.deps = [_keplerGl["default"]];

function ContainerFactory(KeplerGl) {
  /** @lends KeplerGl */

  /**
    * Main Kepler.gl Component
    * @param {Object} props
    *
    * @param {string} props.id - _required_
    *
    * - Default: `map`
    * The id of this KeplerGl instance. `id` is required if you have multiple
    * KeplerGl instances in your app. It defines the prop name of the KeplerGl state that is
    * stored in the KeplerGl reducer. For example, the state of the KeplerGl component with id `foo` is
    * stored in `state.keplerGl.foo`.
    *
    * In case you create multiple kepler.gl instances using the same id, the kepler.gl state defined by the entry will be
    * overridden by the latest instance and reset to a blank state.
    * @param {string} props.mapboxApiAccessToken - _required_
    * @param {string} props.mapboxApiUrl - _optional_
    * @param {Boolean} props.mapStylesReplaceDefault - _optional_
     * You can create a free account at [www.mapbox.com](www.mapbox.com) and create a token at
    * [www.mapbox.com/account/access-tokens](www.mapbox.com/account/access-tokens)
    *
    *
    * @param {Number} props.width - _required_ Width of the KeplerGl UI.
    * @public
   */
  var Container =
  /*#__PURE__*/
  function (_Component) {
    (0, _inherits2["default"])(Container, _Component);

    // default id and address if not provided
    function Container(props, ctx) {
      var _this;

      (0, _classCallCheck2["default"])(this, Container);
      _this = (0, _possibleConstructorReturn2["default"])(this, (0, _getPrototypeOf2["default"])(Container).call(this, props, ctx));
      _this.getSelector = (0, _lodash["default"])(function (id, getState) {
        return function (state) {
          if (!getState(state)) {
            // log error
            _window.console.error(errorMsg.noState);

            return null;
          }

          return getState(state)[id];
        };
      });
      _this.getDispatch = (0, _lodash["default"])(function (id, dispatch) {
        return (0, _actionWrapper.forwardTo)(id, dispatch);
      });
      return _this;
    }

    (0, _createClass2["default"])(Container, [{
      key: "componentWillMount",
      value: function componentWillMount() {
        var _this$props = this.props,
            id = _this$props.id,
            mint = _this$props.mint,
            mapboxApiAccessToken = _this$props.mapboxApiAccessToken,
            mapboxApiUrl = _this$props.mapboxApiUrl,
            mapStylesReplaceDefault = _this$props.mapStylesReplaceDefault; // add a new entry to reducer

        this.props.dispatch((0, _identityActions.registerEntry)({
          id: id,
          mint: mint,
          mapboxApiAccessToken: mapboxApiAccessToken,
          mapboxApiUrl: mapboxApiUrl,
          mapStylesReplaceDefault: mapStylesReplaceDefault
        }));
      }
    }, {
      key: "componentWillReceiveProps",
      value: function componentWillReceiveProps(nextProps) {
        // check if id has changed, if true, copy state over
        if (nextProps.id && nextProps.id !== this.props.id) {
          this.props.dispatch((0, _identityActions.renameEntry)(this.props.id, nextProps.id));
        }
      }
    }, {
      key: "componentWillUnmount",
      value: function componentWillUnmount() {
        if (this.props.mint !== false) {
          // delete entry in reducer
          this.props.dispatch((0, _identityActions.deleteEntry)(this.props.id));
        }
      }
    }, {
      key: "render",
      value: function render() {
        var _this$props2 = this.props,
            id = _this$props2.id,
            getState = _this$props2.getState,
            dispatch = _this$props2.dispatch,
            state = _this$props2.state;
        var selector = this.getSelector(id, getState);

        if (!selector || !selector(state)) {
          // instance state hasn't been mounted yet
          return _react["default"].createElement("div", null);
        }

        return _react["default"].createElement(KeplerGl, (0, _extends2["default"])({}, this.props, {
          id: id,
          selector: selector,
          dispatch: this.getDispatch(id, dispatch)
        }));
      }
    }]);
    return Container;
  }(_react.Component);

  (0, _defineProperty2["default"])(Container, "defaultProps", {
    id: 'map',
    getState: function getState(state) {
      return state.keplerGl;
    },
    mint: true
  });

  var mapStateToProps = function mapStateToProps(state, props) {
    return _objectSpread({
      state: state
    }, props);
  };

  var dispatchToProps = function dispatchToProps(dispatch) {
    return {
      dispatch: dispatch
    };
  };

  return (0, _reactRedux.connect)(mapStateToProps, dispatchToProps)(Container);
} // entryPoint


function flattenDeps(allDeps, factory) {
  var addToDeps = allDeps.concat([factory]);
  return Array.isArray(factory.deps) && factory.deps.length ? factory.deps.reduce(function (accu, dep) {
    return flattenDeps(accu, dep);
  }, addToDeps) : addToDeps;
}

var allDependencies = flattenDeps([], ContainerFactory); // provide all dependencies to appInjector

var appInjector = allDependencies.reduce(function (inj, factory) {
  return inj.provide(factory, factory);
}, (0, _injector.injector)()); // Helper to inject custom components and return kepler.gl container

exports.appInjector = appInjector;

function injectComponents(recipes) {
  if (!Array.isArray(recipes)) {
    _window.console.error(errorMsg.wrongType((0, _typeof2["default"])(recipes)));

    return appInjector.get(ContainerFactory);
  }

  return recipes.reduce(function (inj, recipe) {
    var _inj;

    if (!Array.isArray(recipes)) {
      _window.console.error(errorMsg.wrongPairType);

      return inj;
    } // collect dependencies of custom factories, if there is any.
    // Add them to the injector


    var customDependencies = flattenDeps([], recipe[1]);
    inj = customDependencies.reduce(function (ij, factory) {
      return ij.provide(factory, factory);
    }, inj);
    return (_inj = inj).provide.apply(_inj, (0, _toConsumableArray2["default"])(recipe));
  }, appInjector).get(ContainerFactory);
}

var InjectedContainer = appInjector.get(ContainerFactory);
var _default = InjectedContainer;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21wb25lbnRzL2NvbnRhaW5lci5qcyJdLCJuYW1lcyI6WyJlcnJvck1zZyIsIm5vU3RhdGUiLCJ3cm9uZ1R5cGUiLCJ0eXBlIiwid3JvbmdQYWlyVHlwZSIsIkNvbnRhaW5lckZhY3RvcnkiLCJkZXBzIiwiS2VwbGVyR2xGYWN0b3J5IiwiS2VwbGVyR2wiLCJDb250YWluZXIiLCJwcm9wcyIsImN0eCIsImdldFNlbGVjdG9yIiwiaWQiLCJnZXRTdGF0ZSIsInN0YXRlIiwiQ29uc29sZSIsImVycm9yIiwiZ2V0RGlzcGF0Y2giLCJkaXNwYXRjaCIsIm1pbnQiLCJtYXBib3hBcGlBY2Nlc3NUb2tlbiIsIm1hcGJveEFwaVVybCIsIm1hcFN0eWxlc1JlcGxhY2VEZWZhdWx0IiwibmV4dFByb3BzIiwic2VsZWN0b3IiLCJDb21wb25lbnQiLCJrZXBsZXJHbCIsIm1hcFN0YXRlVG9Qcm9wcyIsImRpc3BhdGNoVG9Qcm9wcyIsImZsYXR0ZW5EZXBzIiwiYWxsRGVwcyIsImZhY3RvcnkiLCJhZGRUb0RlcHMiLCJjb25jYXQiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJyZWR1Y2UiLCJhY2N1IiwiZGVwIiwiYWxsRGVwZW5kZW5jaWVzIiwiYXBwSW5qZWN0b3IiLCJpbmoiLCJwcm92aWRlIiwiaW5qZWN0Q29tcG9uZW50cyIsInJlY2lwZXMiLCJnZXQiLCJyZWNpcGUiLCJjdXN0b21EZXBlbmRlbmNpZXMiLCJpaiIsIkluamVjdGVkQ29udGFpbmVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBb0JBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOzs7Ozs7QUFNTyxJQUFNQSxRQUFRLEdBQUc7QUFDdEJDLEVBQUFBLE9BQU8sRUFDTCxrTUFGb0I7QUFNdEJDLEVBQUFBLFNBQVMsRUFBRSxtQkFBQUMsSUFBSTtBQUFBLFdBQUksd0ZBQ2RBLElBRGMsaUJBQUo7QUFBQSxHQU5PO0FBU3RCQyxFQUFBQSxhQUFhLEVBQUU7QUFUTyxDQUFqQjs7QUFhUEMsZ0JBQWdCLENBQUNDLElBQWpCLEdBQXdCLENBQUNDLG9CQUFELENBQXhCOztBQUVPLFNBQVNGLGdCQUFULENBQTBCRyxRQUExQixFQUFvQztBQUN6Qzs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRnlDLE1BMkJuQ0MsU0EzQm1DO0FBQUE7QUFBQTtBQUFBOztBQTRCdkM7QUFPQSx1QkFBWUMsS0FBWixFQUFtQkMsR0FBbkIsRUFBd0I7QUFBQTs7QUFBQTtBQUN0Qix1SEFBTUQsS0FBTixFQUFhQyxHQUFiO0FBRUEsWUFBS0MsV0FBTCxHQUFtQix3QkFBUSxVQUFDQyxFQUFELEVBQUtDLFFBQUw7QUFBQSxlQUFrQixVQUFBQyxLQUFLLEVBQUk7QUFDcEQsY0FBSSxDQUFDRCxRQUFRLENBQUNDLEtBQUQsQ0FBYixFQUFzQjtBQUNwQjtBQUNBQyw0QkFBUUMsS0FBUixDQUFjakIsUUFBUSxDQUFDQyxPQUF2Qjs7QUFFQSxtQkFBTyxJQUFQO0FBQ0Q7O0FBQ0QsaUJBQU9hLFFBQVEsQ0FBQ0MsS0FBRCxDQUFSLENBQWdCRixFQUFoQixDQUFQO0FBQ0QsU0FSMEI7QUFBQSxPQUFSLENBQW5CO0FBU0EsWUFBS0ssV0FBTCxHQUFtQix3QkFBUSxVQUFDTCxFQUFELEVBQUtNLFFBQUw7QUFBQSxlQUFrQiw4QkFBVU4sRUFBVixFQUFjTSxRQUFkLENBQWxCO0FBQUEsT0FBUixDQUFuQjtBQVpzQjtBQWF2Qjs7QUFoRHNDO0FBQUE7QUFBQSwyQ0FrRGxCO0FBQUEsMEJBQzZELEtBQUtULEtBRGxFO0FBQUEsWUFDWkcsRUFEWSxlQUNaQSxFQURZO0FBQUEsWUFDUk8sSUFEUSxlQUNSQSxJQURRO0FBQUEsWUFDRkMsb0JBREUsZUFDRkEsb0JBREU7QUFBQSxZQUNvQkMsWUFEcEIsZUFDb0JBLFlBRHBCO0FBQUEsWUFDa0NDLHVCQURsQyxlQUNrQ0EsdUJBRGxDLEVBRW5COztBQUNBLGFBQUtiLEtBQUwsQ0FBV1MsUUFBWCxDQUFvQixvQ0FBYztBQUFDTixVQUFBQSxFQUFFLEVBQUZBLEVBQUQ7QUFBS08sVUFBQUEsSUFBSSxFQUFKQSxJQUFMO0FBQVdDLFVBQUFBLG9CQUFvQixFQUFwQkEsb0JBQVg7QUFBaUNDLFVBQUFBLFlBQVksRUFBWkEsWUFBakM7QUFBK0NDLFVBQUFBLHVCQUF1QixFQUF2QkE7QUFBL0MsU0FBZCxDQUFwQjtBQUNEO0FBdERzQztBQUFBO0FBQUEsZ0RBd0RiQyxTQXhEYSxFQXdERjtBQUNuQztBQUNBLFlBQUlBLFNBQVMsQ0FBQ1gsRUFBVixJQUFnQlcsU0FBUyxDQUFDWCxFQUFWLEtBQWlCLEtBQUtILEtBQUwsQ0FBV0csRUFBaEQsRUFBb0Q7QUFDbEQsZUFBS0gsS0FBTCxDQUFXUyxRQUFYLENBQW9CLGtDQUFZLEtBQUtULEtBQUwsQ0FBV0csRUFBdkIsRUFBMkJXLFNBQVMsQ0FBQ1gsRUFBckMsQ0FBcEI7QUFDRDtBQUNGO0FBN0RzQztBQUFBO0FBQUEsNkNBK0RoQjtBQUNyQixZQUFJLEtBQUtILEtBQUwsQ0FBV1UsSUFBWCxLQUFvQixLQUF4QixFQUErQjtBQUM3QjtBQUNBLGVBQUtWLEtBQUwsQ0FBV1MsUUFBWCxDQUFvQixrQ0FBWSxLQUFLVCxLQUFMLENBQVdHLEVBQXZCLENBQXBCO0FBQ0Q7QUFDRjtBQXBFc0M7QUFBQTtBQUFBLCtCQXNFOUI7QUFBQSwyQkFDaUMsS0FBS0gsS0FEdEM7QUFBQSxZQUNBRyxFQURBLGdCQUNBQSxFQURBO0FBQUEsWUFDSUMsUUFESixnQkFDSUEsUUFESjtBQUFBLFlBQ2NLLFFBRGQsZ0JBQ2NBLFFBRGQ7QUFBQSxZQUN3QkosS0FEeEIsZ0JBQ3dCQSxLQUR4QjtBQUVQLFlBQU1VLFFBQVEsR0FBRyxLQUFLYixXQUFMLENBQWlCQyxFQUFqQixFQUFxQkMsUUFBckIsQ0FBakI7O0FBRUEsWUFBSSxDQUFDVyxRQUFELElBQWEsQ0FBQ0EsUUFBUSxDQUFDVixLQUFELENBQTFCLEVBQW1DO0FBQ2pDO0FBQ0EsaUJBQU8sNENBQVA7QUFDRDs7QUFFRCxlQUNFLGdDQUFDLFFBQUQsZ0NBQ00sS0FBS0wsS0FEWDtBQUVFLFVBQUEsRUFBRSxFQUFFRyxFQUZOO0FBR0UsVUFBQSxRQUFRLEVBQUVZLFFBSFo7QUFJRSxVQUFBLFFBQVEsRUFBRSxLQUFLUCxXQUFMLENBQWlCTCxFQUFqQixFQUFxQk0sUUFBckI7QUFKWixXQURGO0FBUUQ7QUF2RnNDO0FBQUE7QUFBQSxJQTJCakJPLGdCQTNCaUI7O0FBQUEsbUNBMkJuQ2pCLFNBM0JtQyxrQkE2QmpCO0FBQ3BCSSxJQUFBQSxFQUFFLEVBQUUsS0FEZ0I7QUFFcEJDLElBQUFBLFFBQVEsRUFBRSxrQkFBQUMsS0FBSztBQUFBLGFBQUlBLEtBQUssQ0FBQ1ksUUFBVjtBQUFBLEtBRks7QUFHcEJQLElBQUFBLElBQUksRUFBRTtBQUhjLEdBN0JpQjs7QUEwRnpDLE1BQU1RLGVBQWUsR0FBRyxTQUFsQkEsZUFBa0IsQ0FBQ2IsS0FBRCxFQUFRTCxLQUFSO0FBQUE7QUFBb0JLLE1BQUFBLEtBQUssRUFBTEE7QUFBcEIsT0FBOEJMLEtBQTlCO0FBQUEsR0FBeEI7O0FBQ0EsTUFBTW1CLGVBQWUsR0FBRyxTQUFsQkEsZUFBa0IsQ0FBQVYsUUFBUTtBQUFBLFdBQUs7QUFBQ0EsTUFBQUEsUUFBUSxFQUFSQTtBQUFELEtBQUw7QUFBQSxHQUFoQzs7QUFDQSxTQUFPLHlCQUFRUyxlQUFSLEVBQXlCQyxlQUF6QixFQUEwQ3BCLFNBQTFDLENBQVA7QUFDRCxDLENBRUQ7OztBQUNBLFNBQVNxQixXQUFULENBQXFCQyxPQUFyQixFQUE4QkMsT0FBOUIsRUFBdUM7QUFDckMsTUFBTUMsU0FBUyxHQUFHRixPQUFPLENBQUNHLE1BQVIsQ0FBZSxDQUFDRixPQUFELENBQWYsQ0FBbEI7QUFDQSxTQUFPRyxLQUFLLENBQUNDLE9BQU4sQ0FBY0osT0FBTyxDQUFDMUIsSUFBdEIsS0FBK0IwQixPQUFPLENBQUMxQixJQUFSLENBQWErQixNQUE1QyxHQUNMTCxPQUFPLENBQUMxQixJQUFSLENBQWFnQyxNQUFiLENBQW9CLFVBQUNDLElBQUQsRUFBT0MsR0FBUDtBQUFBLFdBQWVWLFdBQVcsQ0FBQ1MsSUFBRCxFQUFPQyxHQUFQLENBQTFCO0FBQUEsR0FBcEIsRUFBMkRQLFNBQTNELENBREssR0FFTEEsU0FGRjtBQUdEOztBQUVELElBQU1RLGVBQWUsR0FBR1gsV0FBVyxDQUFDLEVBQUQsRUFBS3pCLGdCQUFMLENBQW5DLEMsQ0FFQTs7QUFDTyxJQUFNcUMsV0FBVyxHQUFHRCxlQUFlLENBQ3ZDSCxNQUR3QixDQUNqQixVQUFDSyxHQUFELEVBQU1YLE9BQU47QUFBQSxTQUFrQlcsR0FBRyxDQUFDQyxPQUFKLENBQVlaLE9BQVosRUFBcUJBLE9BQXJCLENBQWxCO0FBQUEsQ0FEaUIsRUFDZ0MseUJBRGhDLENBQXBCLEMsQ0FHUDs7OztBQUNPLFNBQVNhLGdCQUFULENBQTBCQyxPQUExQixFQUFtQztBQUN4QyxNQUFJLENBQUNYLEtBQUssQ0FBQ0MsT0FBTixDQUFjVSxPQUFkLENBQUwsRUFBNkI7QUFDM0I5QixvQkFBUUMsS0FBUixDQUFjakIsUUFBUSxDQUFDRSxTQUFULDBCQUEwQjRDLE9BQTFCLEVBQWQ7O0FBQ0EsV0FBT0osV0FBVyxDQUFDSyxHQUFaLENBQWdCMUMsZ0JBQWhCLENBQVA7QUFDRDs7QUFFRCxTQUFPeUMsT0FBTyxDQUNYUixNQURJLENBQ0csVUFBQ0ssR0FBRCxFQUFNSyxNQUFOLEVBQWlCO0FBQUE7O0FBQ3ZCLFFBQUksQ0FBQ2IsS0FBSyxDQUFDQyxPQUFOLENBQWNVLE9BQWQsQ0FBTCxFQUE2QjtBQUMzQjlCLHNCQUFRQyxLQUFSLENBQWNqQixRQUFRLENBQUNJLGFBQXZCOztBQUNBLGFBQU91QyxHQUFQO0FBQ0QsS0FKc0IsQ0FNdkI7QUFDQTs7O0FBQ0EsUUFBTU0sa0JBQWtCLEdBQUduQixXQUFXLENBQUMsRUFBRCxFQUFLa0IsTUFBTSxDQUFDLENBQUQsQ0FBWCxDQUF0QztBQUNBTCxJQUFBQSxHQUFHLEdBQUdNLGtCQUFrQixDQUNyQlgsTUFERyxDQUNJLFVBQUNZLEVBQUQsRUFBS2xCLE9BQUw7QUFBQSxhQUFpQmtCLEVBQUUsQ0FBQ04sT0FBSCxDQUFXWixPQUFYLEVBQW9CQSxPQUFwQixDQUFqQjtBQUFBLEtBREosRUFDbURXLEdBRG5ELENBQU47QUFHQSxXQUFPLFFBQUFBLEdBQUcsRUFBQ0MsT0FBSixpREFBZUksTUFBZixFQUFQO0FBQ0QsR0FkSSxFQWNGTixXQWRFLEVBZUpLLEdBZkksQ0FlQTFDLGdCQWZBLENBQVA7QUFnQkQ7O0FBRUQsSUFBTThDLGlCQUFpQixHQUFHVCxXQUFXLENBQUNLLEdBQVosQ0FBZ0IxQyxnQkFBaEIsQ0FBMUI7ZUFFZThDLGlCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDE5IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cblxuaW1wb3J0IFJlYWN0LCB7Q29tcG9uZW50fSBmcm9tICdyZWFjdCc7XG5pbXBvcnQge2Nvbm5lY3R9IGZyb20gJ3JlYWN0LXJlZHV4JztcbmltcG9ydCBtZW1vaXplIGZyb20gJ2xvZGFzaC5tZW1vaXplJztcbmltcG9ydCB7Y29uc29sZSBhcyBDb25zb2xlfSBmcm9tICdnbG9iYWwvd2luZG93JztcbmltcG9ydCB7aW5qZWN0b3J9IGZyb20gJy4vaW5qZWN0b3InO1xuaW1wb3J0IEtlcGxlckdsRmFjdG9yeSBmcm9tICcuL2tlcGxlci1nbCc7XG5pbXBvcnQge2ZvcndhcmRUb30gZnJvbSAnYWN0aW9ucy9hY3Rpb24td3JhcHBlcic7XG5cbmltcG9ydCB7XG4gIHJlZ2lzdGVyRW50cnksXG4gIGRlbGV0ZUVudHJ5LFxuICByZW5hbWVFbnRyeVxufSBmcm9tICdhY3Rpb25zL2lkZW50aXR5LWFjdGlvbnMnO1xuXG5leHBvcnQgY29uc3QgZXJyb3JNc2cgPSB7XG4gIG5vU3RhdGU6XG4gICAgYGtlcGxlci5nbCBzdGF0ZSBkb2VzbnQgZXhpc3QuIGAgK1xuICAgIGBZb3UgbWlnaHQgZm9yZ2V0IHRvIG1vdW50IGtlcGxlckdsUmVkdWNlciBpbiB5b3VyIHJvb3QgcmVkdWNlci5gICtcbiAgICBgSWYgaXQgaXMgbm90IG1vdW50ZWQgYXMgc3RhdGUua2VwbGVyR2wgYnkgZGVmYXVsdCwgeW91IG5lZWQgdG8gcHJvdmlkZSBnZXRTdGF0ZSBhcyBhIHByb3BgLFxuXG4gIHdyb25nVHlwZTogdHlwZSA9PiBgaW5qZWN0Q29tcG9uZW50cyB0YWtlcyBhbiBhcnJheSBvZiBmYWN0b3JpZXMgcmVwbGFjZW1lbnQgcGFpcnMgYXMgaW5wdXQsIGAgK1xuICAgIGAke3R5cGV9IGlzIHByb3ZpZGVkYCxcblxuICB3cm9uZ1BhaXJUeXBlOiBgaW5qZWN0Q29tcG9uZW50cyB0YWtlcyBhbiBhcnJheSBvZiBmYWN0b3JpZXMgcmVwbGFjZW1lbnQgcGFpcnMgYXMgaW5wdXQsIGAgK1xuICBgZWFjaCBwYWlyIGJlIGEgYXJyYXkgYXMgW29yaWdpbmFsRmFjdG9yeSwgcmVwbGFjZW1lbnRdYFxufTtcblxuQ29udGFpbmVyRmFjdG9yeS5kZXBzID0gW0tlcGxlckdsRmFjdG9yeV07XG5cbmV4cG9ydCBmdW5jdGlvbiBDb250YWluZXJGYWN0b3J5KEtlcGxlckdsKSB7XG4gIC8qKiBAbGVuZHMgS2VwbGVyR2wgKi9cbiAgLyoqXG4gICAgKiBNYWluIEtlcGxlci5nbCBDb21wb25lbnRcbiAgICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wc1xuICAgICpcbiAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wcy5pZCAtIF9yZXF1aXJlZF9cbiAgICAqXG4gICAgKiAtIERlZmF1bHQ6IGBtYXBgXG4gICAgKiBUaGUgaWQgb2YgdGhpcyBLZXBsZXJHbCBpbnN0YW5jZS4gYGlkYCBpcyByZXF1aXJlZCBpZiB5b3UgaGF2ZSBtdWx0aXBsZVxuICAgICogS2VwbGVyR2wgaW5zdGFuY2VzIGluIHlvdXIgYXBwLiBJdCBkZWZpbmVzIHRoZSBwcm9wIG5hbWUgb2YgdGhlIEtlcGxlckdsIHN0YXRlIHRoYXQgaXNcbiAgICAqIHN0b3JlZCBpbiB0aGUgS2VwbGVyR2wgcmVkdWNlci4gRm9yIGV4YW1wbGUsIHRoZSBzdGF0ZSBvZiB0aGUgS2VwbGVyR2wgY29tcG9uZW50IHdpdGggaWQgYGZvb2AgaXNcbiAgICAqIHN0b3JlZCBpbiBgc3RhdGUua2VwbGVyR2wuZm9vYC5cbiAgICAqXG4gICAgKiBJbiBjYXNlIHlvdSBjcmVhdGUgbXVsdGlwbGUga2VwbGVyLmdsIGluc3RhbmNlcyB1c2luZyB0aGUgc2FtZSBpZCwgdGhlIGtlcGxlci5nbCBzdGF0ZSBkZWZpbmVkIGJ5IHRoZSBlbnRyeSB3aWxsIGJlXG4gICAgKiBvdmVycmlkZGVuIGJ5IHRoZSBsYXRlc3QgaW5zdGFuY2UgYW5kIHJlc2V0IHRvIGEgYmxhbmsgc3RhdGUuXG4gICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcHMubWFwYm94QXBpQWNjZXNzVG9rZW4gLSBfcmVxdWlyZWRfXG4gICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcHMubWFwYm94QXBpVXJsIC0gX29wdGlvbmFsX1xuICAgICogQHBhcmFtIHtCb29sZWFufSBwcm9wcy5tYXBTdHlsZXNSZXBsYWNlRGVmYXVsdCAtIF9vcHRpb25hbF9cblxuICAgICogWW91IGNhbiBjcmVhdGUgYSBmcmVlIGFjY291bnQgYXQgW3d3dy5tYXBib3guY29tXSh3d3cubWFwYm94LmNvbSkgYW5kIGNyZWF0ZSBhIHRva2VuIGF0XG4gICAgKiBbd3d3Lm1hcGJveC5jb20vYWNjb3VudC9hY2Nlc3MtdG9rZW5zXSh3d3cubWFwYm94LmNvbS9hY2NvdW50L2FjY2Vzcy10b2tlbnMpXG4gICAgKlxuICAgICpcbiAgICAqIEBwYXJhbSB7TnVtYmVyfSBwcm9wcy53aWR0aCAtIF9yZXF1aXJlZF8gV2lkdGggb2YgdGhlIEtlcGxlckdsIFVJLlxuICAgICogQHB1YmxpY1xuICAgKi9cbiAgY2xhc3MgQ29udGFpbmVyIGV4dGVuZHMgQ29tcG9uZW50IHtcbiAgICAvLyBkZWZhdWx0IGlkIGFuZCBhZGRyZXNzIGlmIG5vdCBwcm92aWRlZFxuICAgIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgICBpZDogJ21hcCcsXG4gICAgICBnZXRTdGF0ZTogc3RhdGUgPT4gc3RhdGUua2VwbGVyR2wsXG4gICAgICBtaW50OiB0cnVlXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzLCBjdHgpIHtcbiAgICAgIHN1cGVyKHByb3BzLCBjdHgpO1xuXG4gICAgICB0aGlzLmdldFNlbGVjdG9yID0gbWVtb2l6ZSgoaWQsIGdldFN0YXRlKSA9PiBzdGF0ZSA9PiB7XG4gICAgICAgIGlmICghZ2V0U3RhdGUoc3RhdGUpKSB7XG4gICAgICAgICAgLy8gbG9nIGVycm9yXG4gICAgICAgICAgQ29uc29sZS5lcnJvcihlcnJvck1zZy5ub1N0YXRlKTtcblxuICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBnZXRTdGF0ZShzdGF0ZSlbaWRdO1xuICAgICAgfSk7XG4gICAgICB0aGlzLmdldERpc3BhdGNoID0gbWVtb2l6ZSgoaWQsIGRpc3BhdGNoKSA9PiBmb3J3YXJkVG8oaWQsIGRpc3BhdGNoKSk7XG4gICAgfVxuXG4gICAgY29tcG9uZW50V2lsbE1vdW50KCkge1xuICAgICAgY29uc3Qge2lkLCBtaW50LCBtYXBib3hBcGlBY2Nlc3NUb2tlbiwgbWFwYm94QXBpVXJsLCBtYXBTdHlsZXNSZXBsYWNlRGVmYXVsdH0gPSB0aGlzLnByb3BzO1xuICAgICAgLy8gYWRkIGEgbmV3IGVudHJ5IHRvIHJlZHVjZXJcbiAgICAgIHRoaXMucHJvcHMuZGlzcGF0Y2gocmVnaXN0ZXJFbnRyeSh7aWQsIG1pbnQsIG1hcGJveEFwaUFjY2Vzc1Rva2VuLCBtYXBib3hBcGlVcmwsIG1hcFN0eWxlc1JlcGxhY2VEZWZhdWx0fSkpO1xuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzKSB7XG4gICAgICAvLyBjaGVjayBpZiBpZCBoYXMgY2hhbmdlZCwgaWYgdHJ1ZSwgY29weSBzdGF0ZSBvdmVyXG4gICAgICBpZiAobmV4dFByb3BzLmlkICYmIG5leHRQcm9wcy5pZCAhPT0gdGhpcy5wcm9wcy5pZCkge1xuICAgICAgICB0aGlzLnByb3BzLmRpc3BhdGNoKHJlbmFtZUVudHJ5KHRoaXMucHJvcHMuaWQsIG5leHRQcm9wcy5pZCkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgaWYgKHRoaXMucHJvcHMubWludCAhPT0gZmFsc2UpIHtcbiAgICAgICAgLy8gZGVsZXRlIGVudHJ5IGluIHJlZHVjZXJcbiAgICAgICAgdGhpcy5wcm9wcy5kaXNwYXRjaChkZWxldGVFbnRyeSh0aGlzLnByb3BzLmlkKSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgY29uc3Qge2lkLCBnZXRTdGF0ZSwgZGlzcGF0Y2gsIHN0YXRlfSA9IHRoaXMucHJvcHM7XG4gICAgICBjb25zdCBzZWxlY3RvciA9IHRoaXMuZ2V0U2VsZWN0b3IoaWQsIGdldFN0YXRlKTtcblxuICAgICAgaWYgKCFzZWxlY3RvciB8fCAhc2VsZWN0b3Ioc3RhdGUpKSB7XG4gICAgICAgIC8vIGluc3RhbmNlIHN0YXRlIGhhc24ndCBiZWVuIG1vdW50ZWQgeWV0XG4gICAgICAgIHJldHVybiA8ZGl2IC8+O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gKFxuICAgICAgICA8S2VwbGVyR2xcbiAgICAgICAgICB7Li4udGhpcy5wcm9wc31cbiAgICAgICAgICBpZD17aWR9XG4gICAgICAgICAgc2VsZWN0b3I9e3NlbGVjdG9yfVxuICAgICAgICAgIGRpc3BhdGNoPXt0aGlzLmdldERpc3BhdGNoKGlkLCBkaXNwYXRjaCl9XG4gICAgICAgIC8+XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IG1hcFN0YXRlVG9Qcm9wcyA9IChzdGF0ZSwgcHJvcHMpID0+ICh7c3RhdGUsIC4uLnByb3BzfSk7XG4gIGNvbnN0IGRpc3BhdGNoVG9Qcm9wcyA9IGRpc3BhdGNoID0+ICh7ZGlzcGF0Y2h9KTtcbiAgcmV0dXJuIGNvbm5lY3QobWFwU3RhdGVUb1Byb3BzLCBkaXNwYXRjaFRvUHJvcHMpKENvbnRhaW5lcik7XG59XG5cbi8vIGVudHJ5UG9pbnRcbmZ1bmN0aW9uIGZsYXR0ZW5EZXBzKGFsbERlcHMsIGZhY3RvcnkpIHtcbiAgY29uc3QgYWRkVG9EZXBzID0gYWxsRGVwcy5jb25jYXQoW2ZhY3RvcnldKTtcbiAgcmV0dXJuIEFycmF5LmlzQXJyYXkoZmFjdG9yeS5kZXBzKSAmJiBmYWN0b3J5LmRlcHMubGVuZ3RoID9cbiAgICBmYWN0b3J5LmRlcHMucmVkdWNlKChhY2N1LCBkZXApID0+IGZsYXR0ZW5EZXBzKGFjY3UsIGRlcCksIGFkZFRvRGVwcykgOlxuICAgIGFkZFRvRGVwcztcbn1cblxuY29uc3QgYWxsRGVwZW5kZW5jaWVzID0gZmxhdHRlbkRlcHMoW10sIENvbnRhaW5lckZhY3RvcnkpO1xuXG4vLyBwcm92aWRlIGFsbCBkZXBlbmRlbmNpZXMgdG8gYXBwSW5qZWN0b3JcbmV4cG9ydCBjb25zdCBhcHBJbmplY3RvciA9IGFsbERlcGVuZGVuY2llc1xuICAucmVkdWNlKChpbmosIGZhY3RvcnkpID0+IGluai5wcm92aWRlKGZhY3RvcnksIGZhY3RvcnkpLCBpbmplY3RvcigpKTtcblxuLy8gSGVscGVyIHRvIGluamVjdCBjdXN0b20gY29tcG9uZW50cyBhbmQgcmV0dXJuIGtlcGxlci5nbCBjb250YWluZXJcbmV4cG9ydCBmdW5jdGlvbiBpbmplY3RDb21wb25lbnRzKHJlY2lwZXMpIHtcbiAgaWYgKCFBcnJheS5pc0FycmF5KHJlY2lwZXMpKSB7XG4gICAgQ29uc29sZS5lcnJvcihlcnJvck1zZy53cm9uZ1R5cGUodHlwZW9mKHJlY2lwZXMpKSk7XG4gICAgcmV0dXJuIGFwcEluamVjdG9yLmdldChDb250YWluZXJGYWN0b3J5KTtcbiAgfVxuXG4gIHJldHVybiByZWNpcGVzXG4gICAgLnJlZHVjZSgoaW5qLCByZWNpcGUpID0+IHtcbiAgICAgIGlmICghQXJyYXkuaXNBcnJheShyZWNpcGVzKSkge1xuICAgICAgICBDb25zb2xlLmVycm9yKGVycm9yTXNnLndyb25nUGFpclR5cGUpO1xuICAgICAgICByZXR1cm4gaW5qO1xuICAgICAgfVxuXG4gICAgICAvLyBjb2xsZWN0IGRlcGVuZGVuY2llcyBvZiBjdXN0b20gZmFjdG9yaWVzLCBpZiB0aGVyZSBpcyBhbnkuXG4gICAgICAvLyBBZGQgdGhlbSB0byB0aGUgaW5qZWN0b3JcbiAgICAgIGNvbnN0IGN1c3RvbURlcGVuZGVuY2llcyA9IGZsYXR0ZW5EZXBzKFtdLCByZWNpcGVbMV0pO1xuICAgICAgaW5qID0gY3VzdG9tRGVwZW5kZW5jaWVzXG4gICAgICAgIC5yZWR1Y2UoKGlqLCBmYWN0b3J5KSA9PiBpai5wcm92aWRlKGZhY3RvcnksIGZhY3RvcnkpLCBpbmopO1xuXG4gICAgICByZXR1cm4gaW5qLnByb3ZpZGUoLi4ucmVjaXBlKTtcbiAgICB9LCBhcHBJbmplY3RvcilcbiAgICAuZ2V0KENvbnRhaW5lckZhY3RvcnkpO1xufVxuXG5jb25zdCBJbmplY3RlZENvbnRhaW5lciA9IGFwcEluamVjdG9yLmdldChDb250YWluZXJGYWN0b3J5KTtcblxuZXhwb3J0IGRlZmF1bHQgSW5qZWN0ZWRDb250YWluZXI7XG4iXX0=