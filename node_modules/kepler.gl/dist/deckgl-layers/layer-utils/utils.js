"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getBinColorDomain = getBinColorDomain;
exports.getScaleFunctor = getScaleFunctor;
exports.getColorValueDomain = getColorValueDomain;
exports.getColorScaleFunction = getColorScaleFunction;
exports.getElevationScaleFunction = getElevationScaleFunction;
exports.getRadiusScaleFunction = getRadiusScaleFunction;
exports.needsRecalculateColorDomain = needsRecalculateColorDomain;
exports.needReCalculateScaleFunction = needReCalculateScaleFunction;
exports.needsRecalculateRadiusRange = needsRecalculateRadiusRange;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _dataUtils = require("../../utils/data-utils");

var _defaultSettings = require("../../constants/default-settings");

// Copyright (c) 2019 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
// Enable render color by customized color Scale
function getBinColorDomain(scaleType, bins, _ref) {
  var _ref2 = (0, _slicedToArray2["default"])(_ref, 2),
      lowerIdx = _ref2[0],
      upperIdx = _ref2[1];

  switch (scaleType) {
    case _defaultSettings.SCALE_TYPES.quantize:
      return [bins[lowerIdx].value, bins[upperIdx].value];

    case _defaultSettings.SCALE_TYPES.quantile:
      return bins.slice(lowerIdx, upperIdx + 1).map(function (d) {
        return d.value;
      });

    case _defaultSettings.SCALE_TYPES.ordinal:
      return (0, _dataUtils.unique)(bins.map(function (b) {
        return b.value;
      })).sort();

    default:
      return [bins[lowerIdx].value, bins[upperIdx].value];
  }
}

function getScaleFunctor(scaleType) {
  return _defaultSettings.SCALE_FUNC[scaleType] || _defaultSettings.SCALE_FUNC.quantile;
}

function getColorValueDomain(layer) {
  var _layer$props = layer.props,
      lowerPercentile = _layer$props.lowerPercentile,
      upperPercentile = _layer$props.upperPercentile,
      colorScale = _layer$props.colorScale;
  var sortedBins = layer.state.sortedColorBins.sortedBins;
  var len = sortedBins.length;

  if (!len) {
    // err... what do we do
    layer.state.colorValueDomain = null;
  } else {
    var lowerIdx = Math.ceil(lowerPercentile / 100 * (len - 1));
    var upperIdx = Math.floor(upperPercentile / 100 * (len - 1)); // calculate valueDomain based on

    layer.state.colorValueDomain = getBinColorDomain(colorScale, sortedBins, [lowerIdx, upperIdx]);
    layer.getColorScale();
  }

  layer.props.onSetColorDomain(layer.state.colorValueDomain);
}

function getColorScaleFunction(layer) {
  var _layer$props2 = layer.props,
      colorScale = _layer$props2.colorScale,
      colorDomain = _layer$props2.colorDomain;
  layer.state.colorScaleFunc = getScaleFunctor(colorScale)().domain(colorDomain || layer.state.colorDomain || layer.state.colorValueDomain).range(layer.props.colorRange);
}

function getElevationScaleFunction(layer) {
  var elevationRange = layer.props.elevationRange;
  var elevationDomain = layer.props.elevationDomain || layer.state.elevationValueDomain;
  layer.state.elevationScaleFunc = getScaleFunctor(layer.props.sizeScale)().domain(elevationDomain).range(elevationRange);
}

function getRadiusScaleFunction(layer) {
  var viewport = layer.context.viewport;
  layer.state.radiusScaleFunc = _defaultSettings.SCALE_FUNC.sqrt().domain(layer.state.radiusDomain).range(layer.props.radiusRange.map(function (d) {
    return d * viewport.distanceScales.metersPerPixel[0];
  }));
}

function needsRecalculateColorDomain(oldProps, props) {
  return oldProps.lowerPercentile !== props.lowerPercentile || oldProps.upperPercentile !== props.upperPercentile || oldProps.colorScale !== props.colorScale;
}

function needReCalculateScaleFunction(oldProps, props) {
  return oldProps.colorRange !== props.colorRange;
}

function needsRecalculateRadiusRange(oldProps, props) {
  return oldProps.radiusRange !== props.radiusRange && (oldProps.radiusRange[0] !== props.radiusRange[0] || oldProps.radiusRange[1] !== props.radiusRange[1]);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kZWNrZ2wtbGF5ZXJzL2xheWVyLXV0aWxzL3V0aWxzLmpzIl0sIm5hbWVzIjpbImdldEJpbkNvbG9yRG9tYWluIiwic2NhbGVUeXBlIiwiYmlucyIsImxvd2VySWR4IiwidXBwZXJJZHgiLCJTQ0FMRV9UWVBFUyIsInF1YW50aXplIiwidmFsdWUiLCJxdWFudGlsZSIsInNsaWNlIiwibWFwIiwiZCIsIm9yZGluYWwiLCJiIiwic29ydCIsImdldFNjYWxlRnVuY3RvciIsIlNDQUxFX0ZVTkMiLCJnZXRDb2xvclZhbHVlRG9tYWluIiwibGF5ZXIiLCJwcm9wcyIsImxvd2VyUGVyY2VudGlsZSIsInVwcGVyUGVyY2VudGlsZSIsImNvbG9yU2NhbGUiLCJzb3J0ZWRCaW5zIiwic3RhdGUiLCJzb3J0ZWRDb2xvckJpbnMiLCJsZW4iLCJsZW5ndGgiLCJjb2xvclZhbHVlRG9tYWluIiwiTWF0aCIsImNlaWwiLCJmbG9vciIsImdldENvbG9yU2NhbGUiLCJvblNldENvbG9yRG9tYWluIiwiZ2V0Q29sb3JTY2FsZUZ1bmN0aW9uIiwiY29sb3JEb21haW4iLCJjb2xvclNjYWxlRnVuYyIsImRvbWFpbiIsInJhbmdlIiwiY29sb3JSYW5nZSIsImdldEVsZXZhdGlvblNjYWxlRnVuY3Rpb24iLCJlbGV2YXRpb25SYW5nZSIsImVsZXZhdGlvbkRvbWFpbiIsImVsZXZhdGlvblZhbHVlRG9tYWluIiwiZWxldmF0aW9uU2NhbGVGdW5jIiwic2l6ZVNjYWxlIiwiZ2V0UmFkaXVzU2NhbGVGdW5jdGlvbiIsInZpZXdwb3J0IiwiY29udGV4dCIsInJhZGl1c1NjYWxlRnVuYyIsInNxcnQiLCJyYWRpdXNEb21haW4iLCJyYWRpdXNSYW5nZSIsImRpc3RhbmNlU2NhbGVzIiwibWV0ZXJzUGVyUGl4ZWwiLCJuZWVkc1JlY2FsY3VsYXRlQ29sb3JEb21haW4iLCJvbGRQcm9wcyIsIm5lZWRSZUNhbGN1bGF0ZVNjYWxlRnVuY3Rpb24iLCJuZWVkc1JlY2FsY3Vs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QXdCQyxjQUF4QixDQUF1QyxDQUF2QyxDQUFSO0FBQUEsR0FESCxDQUgwQixDQUE5QjtBQU9EOztBQUVNLFNBQVNDLDJCQUFULENBQXFDQyxRQUFyQyxFQUErQ3JDLEtBQS9DLEVBQXNEO0FBQzNELFNBQ0VxQyxRQUFRLENBQUNwQyxlQUFULEtBQTZCRCxLQUFLLENBQUNDLGVBQW5DLElBQ0FvQyxRQUFRLENBQUNuQyxlQUFULEtBQTZCRixLQUFLLENBQUNFLGVBRG5DLElBRUFtQyxRQUFRLENBQUNsQyxVQUFULEtBQXdCSCxLQUFLLENBQUNHLFVBSGhDO0FBS0Q7O0FBRU0sU0FBU21DLDRCQUFULENBQXNDRCxRQUF0QyxFQUFnRHJDLEtBQWhELEVBQXVEO0FBQzVELFNBQU9xQyxRQUFRLENBQUNqQixVQUFULEtBQXdCcEIsS0FBSyxDQUFDb0IsVUFBckM7QUFDRDs7QUFFTSxTQUFTbUIsMkJBQVQsQ0FBcUNGLFFBQXJDLEVBQStDckMsS0FBL0MsRUFBc0Q7QUFDM0QsU0FDRXFDLFFBQVEsQ0FBQ0osV0FBVCxLQUF5QmpDLEtBQUssQ0FBQ2lDLFdBQS9CLEtBQ0NJLFFBQVEsQ0FBQ0osV0FBVCxDQUFxQixDQUFyQixNQUE0QmpDLEtBQUssQ0FBQ2lDLFdBQU4sQ0FBa0IsQ0FBbEIsQ0FBNUIsSUFDQ0ksUUFBUSxDQUFDSixXQUFULENBQXFCLENBQXJCLE1BQTRCakMsS0FBSyxDQUFDaUMsV0FBTixDQUFrQixDQUFsQixDQUY5QixDQURGO0FBS0QiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIDIwMTkgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXG5pbXBvcnQge3VuaXF1ZX0gZnJvbSAndXRpbHMvZGF0YS11dGlscyc7XG5cbmltcG9ydCB7U0NBTEVfVFlQRVMsIFNDQUxFX0ZVTkN9IGZyb20gJ2NvbnN0YW50cy9kZWZhdWx0LXNldHRpbmdzJztcblxuLy8gRW5hYmxlIHJlbmRlciBjb2xvciBieSBjdXN0b21pemVkIGNvbG9yIFNjYWxlXG5leHBvcnQgZnVuY3Rpb24gZ2V0QmluQ29sb3JEb21haW4oc2NhbGVUeXBlLCBiaW5zLCBbbG93ZXJJZHgsIHVwcGVySWR4XSkge1xuICBzd2l0Y2ggKHNjYWxlVHlwZSkge1xuICAgIGNhc2UgU0NBTEVfVFlQRVMucXVhbnRpemU6XG4gICAgICByZXR1cm4gW2JpbnNbbG93ZXJJZHhdLnZhbHVlLCBiaW5zW3VwcGVySWR4XS52YWx1ZV07XG5cbiAgICBjYXNlIFNDQUxFX1RZUEVTLnF1YW50aWxlOlxuICAgICAgcmV0dXJuIGJpbnMuc2xpY2UobG93ZXJJZHgsIHVwcGVySWR4ICsgMSkubWFwKGQgPT4gZC52YWx1ZSk7XG4gICAgY2FzZSBTQ0FMRV9UWVBFUy5vcmRpbmFsOlxuICAgICAgcmV0dXJuIHVuaXF1ZShiaW5zLm1hcChiID0+IGIudmFsdWUpKS5zb3J0KCk7XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiBbYmluc1tsb3dlcklkeF0udmFsdWUsIGJpbnNbdXBwZXJJZHhdLnZhbHVlXTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2NhbGVGdW5jdG9yKHNjYWxlVHlwZSkge1xuICByZXR1cm4gU0NBTEVfRlVOQ1tzY2FsZVR5cGVdIHx8IFNDQUxFX0ZVTkMucXVhbnRpbGU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb2xvclZhbHVlRG9tYWluKGxheWVyKSB7XG4gIGNvbnN0IHtsb3dlclBlcmNlbnRpbGUsIHVwcGVyUGVyY2VudGlsZSwgY29sb3JTY2FsZX0gPSBsYXllci5wcm9wcztcbiAgY29uc3Qge3NvcnRlZEJpbnN9ID0gbGF5ZXIuc3RhdGUuc29ydGVkQ29sb3JCaW5zO1xuICBjb25zdCBsZW4gPSBzb3J0ZWRCaW5zLmxlbmd0aDtcblxuICBpZiAoIWxlbikge1xuICAgIC8vIGVyci4uLiB3aGF0IGRvIHdlIGRvXG4gICAgbGF5ZXIuc3RhdGUuY29sb3JWYWx1ZURvbWFpbiA9IG51bGw7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgbG93ZXJJZHggPSBNYXRoLmNlaWwobG93ZXJQZXJjZW50aWxlIC8gMTAwICogKGxlbiAtIDEpKTtcbiAgICBjb25zdCB1cHBlcklkeCA9IE1hdGguZmxvb3IodXBwZXJQZXJjZW50aWxlIC8gMTAwICogKGxlbiAtIDEpKTtcblxuICAgIC8vIGNhbGN1bGF0ZSB2YWx1ZURvbWFpbiBiYXNlZCBvblxuICAgIGxheWVyLnN0YXRlLmNvbG9yVmFsdWVEb21haW4gPSBnZXRCaW5Db2xvckRvbWFpbihjb2xvclNjYWxlLCBzb3J0ZWRCaW5zLCBbXG4gICAgICBsb3dlcklkeCxcbiAgICAgIHVwcGVySWR4XG4gICAgXSk7XG4gICAgbGF5ZXIuZ2V0Q29sb3JTY2FsZSgpO1xuICB9XG5cbiAgbGF5ZXIucHJvcHMub25TZXRDb2xvckRvbWFpbihsYXllci5zdGF0ZS5jb2xvclZhbHVlRG9tYWluKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENvbG9yU2NhbGVGdW5jdGlvbihsYXllcikge1xuICBjb25zdCB7Y29sb3JTY2FsZSwgY29sb3JEb21haW59ID0gbGF5ZXIucHJvcHM7XG4gIGxheWVyLnN0YXRlLmNvbG9yU2NhbGVGdW5jID0gZ2V0U2NhbGVGdW5jdG9yKGNvbG9yU2NhbGUpKClcbiAgICAuZG9tYWluKFxuICAgICAgY29sb3JEb21haW4gfHwgbGF5ZXIuc3RhdGUuY29sb3JEb21haW4gfHwgbGF5ZXIuc3RhdGUuY29sb3JWYWx1ZURvbWFpblxuICAgIClcbiAgICAucmFuZ2UobGF5ZXIucHJvcHMuY29sb3JSYW5nZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRFbGV2YXRpb25TY2FsZUZ1bmN0aW9uKGxheWVyKSB7XG4gIGNvbnN0IGVsZXZhdGlvblJhbmdlID0gbGF5ZXIucHJvcHMuZWxldmF0aW9uUmFuZ2U7XG4gIGNvbnN0IGVsZXZhdGlvbkRvbWFpbiA9IGxheWVyLnByb3BzLmVsZXZhdGlvbkRvbWFpbiB8fCBsYXllci5zdGF0ZS5lbGV2YXRpb25WYWx1ZURvbWFpbjtcblxuICBsYXllci5zdGF0ZS5lbGV2YXRpb25TY2FsZUZ1bmMgPSBnZXRTY2FsZUZ1bmN0b3IobGF5ZXIucHJvcHMuc2l6ZVNjYWxlKSgpXG4gICAgLmRvbWFpbihlbGV2YXRpb25Eb21haW4pXG4gICAgLnJhbmdlKGVsZXZhdGlvblJhbmdlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFJhZGl1c1NjYWxlRnVuY3Rpb24obGF5ZXIpIHtcbiAgY29uc3Qge3ZpZXdwb3J0fSA9IGxheWVyLmNvbnRleHQ7XG4gIGxheWVyLnN0YXRlLnJhZGl1c1NjYWxlRnVuYyA9IFNDQUxFX0ZVTkMuc3FydCgpXG4gICAgLmRvbWFpbihsYXllci5zdGF0ZS5yYWRpdXNEb21haW4pXG4gICAgLnJhbmdlKFxuICAgICAgbGF5ZXIucHJvcHMucmFkaXVzUmFuZ2UubWFwKFxuICAgICAgICBkID0+IGQgKiB2aWV3cG9ydC5kaXN0YW5jZVNjYWxlcy5tZXRlcnNQZXJQaXhlbFswXVxuICAgICAgKVxuICAgICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBuZWVkc1JlY2FsY3VsYXRlQ29sb3JEb21haW4ob2xkUHJvcHMsIHByb3BzKSB7XG4gIHJldHVybiAoXG4gICAgb2xkUHJvcHMubG93ZXJQZXJjZW50aWxlICE9PSBwcm9wcy5sb3dlclBlcmNlbnRpbGUgfHxcbiAgICBvbGRQcm9wcy51cHBlclBlcmNlbnRpbGUgIT09IHByb3BzLnVwcGVyUGVyY2VudGlsZSB8fFxuICAgIG9sZFByb3BzLmNvbG9yU2NhbGUgIT09IHByb3BzLmNvbG9yU2NhbGVcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5lZWRSZUNhbGN1bGF0ZVNjYWxlRnVuY3Rpb24ob2xkUHJvcHMsIHByb3BzKSB7XG4gIHJldHVybiBvbGRQcm9wcy5jb2xvclJhbmdlICE9PSBwcm9wcy5jb2xvclJhbmdlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbmVlZHNSZWNhbGN1bGF0ZVJhZGl1c1JhbmdlKG9sZFByb3BzLCBwcm9wcykge1xuICByZXR1cm4gKFxuICAgIG9sZFByb3BzLnJhZGl1c1JhbmdlICE9PSBwcm9wcy5yYWRpdXNSYW5nZSAmJlxuICAgIChvbGRQcm9wcy5yYWRpdXNSYW5nZVswXSAhPT0gcHJvcHMucmFkaXVzUmFuZ2VbMF0gfHxcbiAgICAgIG9sZFByb3BzLnJhZGl1c1JhbmdlWzFdICE9PSBwcm9wcy5yYWRpdXNSYW5nZVsxXSlcbiAgKTtcbn1cbiJdfQ==