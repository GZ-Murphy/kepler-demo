"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.coordHasLength4 = coordHasLength4;
exports.containValidTime = containValidTime;
exports.isTripGeoJsonField = isTripGeoJsonField;
exports.parseTripGeoJsonTimestamp = parseTripGeoJsonTimestamp;
exports.getAnimationDomainFromTimestamps = getAnimationDomainFromTimestamps;

var _typeAnalyzer = require("type-analyzer");

var _dataUtils = require("../../utils/data-utils");

var _geojsonUtils = require("../geojson-layer/geojson-utils");

// Copyright (c) 2019 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

/**
 * Parse geojson from string
 * @param {array} geojson feature object values
 * @returns {boolean} whether the geometry coordinates has length of 4
 */
function coordHasLength4(samples) {
  var hasLength4 = true;

  for (var i = 0; i < samples.length; i += 1) {
    hasLength4 = !samples[i].geometry.coordinates.find(function (c) {
      return c.length < 4;
    });

    if (!hasLength4) {
      break;
    }
  }

  return hasLength4;
}
/**
 * Check whether geojson linestring's 4th coordinate is 1) not timestamp 2) unix time stamp 3) real date time
 * @param {array} data array to be tested if its elements are timestamp
 * @returns {string} the type of timestamp: unix/datetime/invalid(not timestamp)
 */


function containValidTime(timestamps) {
  var formattedTimeStamps = timestamps.map(function (ts) {
    return {
      ts: ts
    };
  });
  var ignoredDataTypes = Object.keys(_typeAnalyzer.DATA_TYPES).filter(function (type) {
    return ![_typeAnalyzer.DATA_TYPES.TIME, _typeAnalyzer.DATA_TYPES.DATETIME].includes(type);
  }); // ignore all types but TIME to improve performance

  var analyzedType = _typeAnalyzer.Analyzer.computeColMeta(formattedTimeStamps, [], {
    ignoredDataTypes: ignoredDataTypes
  })[0];

  if (!analyzedType || analyzedType.category !== 'TIME') {
    return false;
  }

  return analyzedType;
}
/**
 * Check if geojson features are trip layer animatable by meeting 3 conditions
 * @param {array} features array of geojson feature objects
 * @returns {boolean} whether it is trip layer animatable
 */


function isTripGeoJsonField() {
  var allData = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var field = arguments.length > 1 ? arguments[1] : undefined;

  if (!allData.length) {
    return false;
  }

  var getValue = function getValue(d) {
    return d[field.tableFieldIndex - 1];
  };

  var maxCount = 10000;
  var sampleRawFeatures = allData.length > maxCount ? (0, _dataUtils.getSampleData)(allData, maxCount, getValue) : allData.map(getValue);
  var features = sampleRawFeatures.map(_geojsonUtils.parseGeoJsonRawFeature);
  var featureTypes = (0, _geojsonUtils.getGeojsonFeatureTypes)(features); // condition 1: contain line string

  if (!featureTypes.line) {
    return false;
  } // condition 2:sample line strings contain 4 coordinates


  if (!coordHasLength4(features)) {
    return false;
  } // condition 3:the 4th coordinate of the first feature line strings is valid time


  var tsHolder = features[0].geometry.coordinates.map(function (coord) {
    return coord[3];
  });
  return Boolean(containValidTime(tsHolder));
}
/**
 * Get unix timestamp from animatable geojson for deck.gl trip layer
 * @param {Array<Object>} dataToFeature array of geojson feature objects, can be null
 * @returns {Array<Number>} unix timestamp in milliseconds
 */


function parseTripGeoJsonTimestamp(dataToFeature) {
  // Analyze type based on coordinates of the 1st lineString
  // select a sample trip to analyze time format
  var empty = {
    dataToTimeStamp: [],
    animationDomain: null
  };
  var sampleTrip = dataToFeature.find(function (f) {
    return f && f.geometry && f.geometry.coordinates && f.geometry.coordinates.length >= 3;
  }); // if no valid geometry

  if (!sampleTrip) {
    return empty;
  }

  var analyzedType = containValidTime(sampleTrip.geometry.coordinates.map(function (coord) {
    return coord[3];
  }));

  if (!analyzedType) {
    return empty;
  }

  var format = analyzedType.format;

  var getTimeValue = function getTimeValue(coord) {
    return coord && (0, _dataUtils.notNullorUndefined)(coord[3]) ? (0, _dataUtils.timeToUnixMilli)(coord[3], format) : null;
  };

  var dataToTimeStamp = dataToFeature.map(function (f) {
    return f && f.geometry && Array.isArray(f.geometry.coordinates) ? f.geometry.coordinates.map(getTimeValue) : null;
  });
  var animationDomain = getAnimationDomainFromTimestamps(dataToTimeStamp);
  return {
    dataToTimeStamp: dataToTimeStamp,
    animationDomain: animationDomain
  };
}

function findMinFromSorted() {
  var list = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  return list.find(_dataUtils.notNullorUndefined) || null;
}

function findMaxFromSorted() {
  var list = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  var i = list.length - 1;

  while (i > 0) {
    if ((0, _dataUtils.notNullorUndefined)(list[i])) {
      return list[i];
    }

    i--;
  }

  return null;
}

function getAnimationDomainFromTimestamps() {
  var dataToTimeStamp = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];
  return dataToTimeStamp.reduce(function (accu, tss) {
    accu[0] = Math.min(accu[0], findMinFromSorted(tss));
    accu[1] = Math.max(accu[1], findMaxFromSorted(tss));
    return accu;
  }, [Infinity, -Infinity]);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYXllcnMvdHJpcC1sYXllci90cmlwLXV0aWxzLmpzIl0sIm5hbWVzIjpbImNvb3JkSGFzTGVuZ3RoNCIsInNhbXBsZXMiLCJoYXNMZW5ndGg0IiwiaSIsImxlbmd0aCIsImdlb21ldHJ5IiwiY29vcmRpbmF0ZXMiLCJmaW5kIiwiYyIsImNvbnRhaW5WYWxpZFRpbWUiLCJ0aW1lc3RhbXBzIiwiZm9ybWF0dGVkVGltZVN0YW1wcyIsIm1hcCIsInRzIiwiaWdub3JlZERhdGFUeXBlcyIsIk9iamVjdCIsImtleXMiLCJEQVRBX1RZUEVTIiwiZmlsdGVyIiwidHlwZSIsIlRJTUUiLCJEQVRFVElNRSIsImluY2x1ZGVzIiwiYW5hbHl6ZWRUeXBlIiwiQW5hbHl6ZXIiLCJjb21wdXRlQ29sTWV0YSIsImNhdGVnb3J5IiwiaXNUcmlwR2VvSnNvbkZpZWxkIiwiYWxsRGF0YSIsImZpZWxkIiwiZ2V0VmFsdWUiLCJkIiwidGFibGVGaWVsZEluZGV4IiwibWF4Q291bnQiLCJzYW1wbGVSYXdGZWF0dXJlcyIsImZlYXR1cmVzIiwicGFyc2VHZW9Kc29uUmF3RmVhdHVyZSIsImZlYXR1cmVUeXBlcyIsImxpbmUiLCJ0c0hvbGRlciIsImNvb3JkIiwiQm9vbGVhbiIsInBhcnNlVHJpcEdlb0pzb25UaW1lc3RhbXAiLCJkYXRhVG9GZWF0dXJlIiwiZW1wdHkiLCJkYXRhVG9UaW1lU3RhbXAiLCJhbmltYXRpb25Eb21haW4iLCJzYW1wbGVUcmlwIiwiZiIsImZvcm1hdCIsImdldFRpbWVWYWx1ZSIsIkFycmF5IiwiaXNBcnJheSIsImdldEFuaW1hdGlvbkRvbWFpbkZyb21UaW1lc3RhbXBzIiwiZmluZE1pbkZyb21Tb3J0ZWQiLCJsaXN0Iiwibm90TnVsbG9yVW5kZWZpbmVkIiwiZmluZE1heEZyb21Tb3J0ZWQiLCJyZWR1Y2UiLCJhY2N1IiwidHNzIiwiTWF0aCIsIm1pbiIsIm1heCIsIkluZmluaXR5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztB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QU8sSUFBUDtBQUNEOztBQUVNLFNBQVNrRCxnQ0FBVCxHQUFnRTtBQUFBLE1BQXRCUixlQUFzQix1RUFBSixFQUFJO0FBQ3JFLFNBQU9BLGVBQWUsQ0FBQ2EsTUFBaEIsQ0FDTCxVQUFDQyxJQUFELEVBQU9DLEdBQVAsRUFBZTtBQUNiRCxJQUFBQSxJQUFJLENBQUMsQ0FBRCxDQUFKLEdBQVVFLElBQUksQ0FBQ0MsR0FBTCxDQUFTSCxJQUFJLENBQUMsQ0FBRCxDQUFiLEVBQWtCTCxpQkFBaUIsQ0FBQ00sR0FBRCxDQUFuQyxDQUFWO0FBQ0FELElBQUFBLElBQUksQ0FBQyxDQUFELENBQUosR0FBVUUsSUFBSSxDQUFDRSxHQUFMLENBQVNKLElBQUksQ0FBQyxDQUFELENBQWIsRUFBa0JGLGlCQUFpQixDQUFDRyxHQUFELENBQW5DLENBQVY7QUFDQSxXQUFPRCxJQUFQO0FBQ0QsR0FMSSxFQU1MLENBQUNLLFFBQUQsRUFBVyxDQUFDQSxRQUFaLENBTkssQ0FBUDtBQVFEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDE5IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cblxuaW1wb3J0IHtBbmFseXplciwgREFUQV9UWVBFU30gZnJvbSAndHlwZS1hbmFseXplcic7XG5cbmltcG9ydCB7XG4gIGdldFNhbXBsZURhdGEsXG4gIHRpbWVUb1VuaXhNaWxsaSxcbiAgbm90TnVsbG9yVW5kZWZpbmVkXG59IGZyb20gJ3V0aWxzL2RhdGEtdXRpbHMnO1xuXG5pbXBvcnQge1xuICBwYXJzZUdlb0pzb25SYXdGZWF0dXJlLFxuICBnZXRHZW9qc29uRmVhdHVyZVR5cGVzXG59IGZyb20gJ2xheWVycy9nZW9qc29uLWxheWVyL2dlb2pzb24tdXRpbHMnO1xuXG4vKipcbiAqIFBhcnNlIGdlb2pzb24gZnJvbSBzdHJpbmdcbiAqIEBwYXJhbSB7YXJyYXl9IGdlb2pzb24gZmVhdHVyZSBvYmplY3QgdmFsdWVzXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gd2hldGhlciB0aGUgZ2VvbWV0cnkgY29vcmRpbmF0ZXMgaGFzIGxlbmd0aCBvZiA0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb29yZEhhc0xlbmd0aDQoc2FtcGxlcykge1xuICBsZXQgaGFzTGVuZ3RoNCA9IHRydWU7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgc2FtcGxlcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgIGhhc0xlbmd0aDQgPSAhc2FtcGxlc1tpXS5nZW9tZXRyeS5jb29yZGluYXRlcy5maW5kKGMgPT4gYy5sZW5ndGggPCA0KTtcbiAgICBpZiAoIWhhc0xlbmd0aDQpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuICByZXR1cm4gaGFzTGVuZ3RoNDtcbn1cblxuLyoqXG4gKiBDaGVjayB3aGV0aGVyIGdlb2pzb24gbGluZXN0cmluZydzIDR0aCBjb29yZGluYXRlIGlzIDEpIG5vdCB0aW1lc3RhbXAgMikgdW5peCB0aW1lIHN0YW1wIDMpIHJlYWwgZGF0ZSB0aW1lXG4gKiBAcGFyYW0ge2FycmF5fSBkYXRhIGFycmF5IHRvIGJlIHRlc3RlZCBpZiBpdHMgZWxlbWVudHMgYXJlIHRpbWVzdGFtcFxuICogQHJldHVybnMge3N0cmluZ30gdGhlIHR5cGUgb2YgdGltZXN0YW1wOiB1bml4L2RhdGV0aW1lL2ludmFsaWQobm90IHRpbWVzdGFtcClcbiAqL1xuXG5leHBvcnQgZnVuY3Rpb24gY29udGFpblZhbGlkVGltZSh0aW1lc3RhbXBzKSB7XG4gIGNvbnN0IGZvcm1hdHRlZFRpbWVTdGFtcHMgPSB0aW1lc3RhbXBzLm1hcCh0cyA9PiAoe3RzfSkpO1xuICBjb25zdCBpZ25vcmVkRGF0YVR5cGVzID0gT2JqZWN0LmtleXMoREFUQV9UWVBFUykuZmlsdGVyKHR5cGUgPT5cbiAgICAhW0RBVEFfVFlQRVMuVElNRSwgREFUQV9UWVBFUy5EQVRFVElNRV0uaW5jbHVkZXModHlwZSkpO1xuXG4gIC8vIGlnbm9yZSBhbGwgdHlwZXMgYnV0IFRJTUUgdG8gaW1wcm92ZSBwZXJmb3JtYW5jZVxuICBjb25zdCBhbmFseXplZFR5cGUgPSBBbmFseXplci5jb21wdXRlQ29sTWV0YShmb3JtYXR0ZWRUaW1lU3RhbXBzLCBbXSwge2lnbm9yZWREYXRhVHlwZXN9KVswXTtcblxuICBpZiAoIWFuYWx5emVkVHlwZSB8fCBhbmFseXplZFR5cGUuY2F0ZWdvcnkgIT09ICdUSU1FJykge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICByZXR1cm4gYW5hbHl6ZWRUeXBlO1xufVxuXG4vKipcbiAqIENoZWNrIGlmIGdlb2pzb24gZmVhdHVyZXMgYXJlIHRyaXAgbGF5ZXIgYW5pbWF0YWJsZSBieSBtZWV0aW5nIDMgY29uZGl0aW9uc1xuICogQHBhcmFtIHthcnJheX0gZmVhdHVyZXMgYXJyYXkgb2YgZ2VvanNvbiBmZWF0dXJlIG9iamVjdHNcbiAqIEByZXR1cm5zIHtib29sZWFufSB3aGV0aGVyIGl0IGlzIHRyaXAgbGF5ZXIgYW5pbWF0YWJsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNUcmlwR2VvSnNvbkZpZWxkKGFsbERhdGEgPSBbXSwgZmllbGQpIHtcbiAgaWYgKCFhbGxEYXRhLmxlbmd0aCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICBjb25zdCBnZXRWYWx1ZSA9IGQgPT4gZFtmaWVsZC50YWJsZUZpZWxkSW5kZXggLSAxXTtcbiAgY29uc3QgbWF4Q291bnQgPSAxMDAwMDtcbiAgY29uc3Qgc2FtcGxlUmF3RmVhdHVyZXMgPVxuICAgIGFsbERhdGEubGVuZ3RoID4gbWF4Q291bnQgPyBnZXRTYW1wbGVEYXRhKGFsbERhdGEsIG1heENvdW50LCBnZXRWYWx1ZSkgOiBhbGxEYXRhLm1hcChnZXRWYWx1ZSk7XG5cbiAgY29uc3QgZmVhdHVyZXMgPSBzYW1wbGVSYXdGZWF0dXJlcy5tYXAocGFyc2VHZW9Kc29uUmF3RmVhdHVyZSk7XG5cbiAgY29uc3QgZmVhdHVyZVR5cGVzID0gZ2V0R2VvanNvbkZlYXR1cmVUeXBlcyhmZWF0dXJlcyk7XG5cbiAgLy8gY29uZGl0aW9uIDE6IGNvbnRhaW4gbGluZSBzdHJpbmdcbiAgaWYgKCFmZWF0dXJlVHlwZXMubGluZSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8vIGNvbmRpdGlvbiAyOnNhbXBsZSBsaW5lIHN0cmluZ3MgY29udGFpbiA0IGNvb3JkaW5hdGVzXG4gIGlmICghY29vcmRIYXNMZW5ndGg0KGZlYXR1cmVzKSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8vIGNvbmRpdGlvbiAzOnRoZSA0dGggY29vcmRpbmF0ZSBvZiB0aGUgZmlyc3QgZmVhdHVyZSBsaW5lIHN0cmluZ3MgaXMgdmFsaWQgdGltZVxuICBjb25zdCB0c0hvbGRlciA9IGZlYXR1cmVzWzBdLmdlb21ldHJ5LmNvb3JkaW5hdGVzLm1hcChcbiAgICBjb29yZCA9PiBjb29yZFszXVxuICApO1xuXG4gIHJldHVybiBCb29sZWFuKGNvbnRhaW5WYWxpZFRpbWUodHNIb2xkZXIpKTtcbn1cblxuLyoqXG4gKiBHZXQgdW5peCB0aW1lc3RhbXAgZnJvbSBhbmltYXRhYmxlIGdlb2pzb24gZm9yIGRlY2suZ2wgdHJpcCBsYXllclxuICogQHBhcmFtIHtBcnJheTxPYmplY3Q+fSBkYXRhVG9GZWF0dXJlIGFycmF5IG9mIGdlb2pzb24gZmVhdHVyZSBvYmplY3RzLCBjYW4gYmUgbnVsbFxuICogQHJldHVybnMge0FycmF5PE51bWJlcj59IHVuaXggdGltZXN0YW1wIGluIG1pbGxpc2Vjb25kc1xuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VUcmlwR2VvSnNvblRpbWVzdGFtcChkYXRhVG9GZWF0dXJlKSB7XG4gIC8vIEFuYWx5emUgdHlwZSBiYXNlZCBvbiBjb29yZGluYXRlcyBvZiB0aGUgMXN0IGxpbmVTdHJpbmdcbiAgLy8gc2VsZWN0IGEgc2FtcGxlIHRyaXAgdG8gYW5hbHl6ZSB0aW1lIGZvcm1hdFxuICBjb25zdCBlbXB0eSA9IHtkYXRhVG9UaW1lU3RhbXA6IFtdLCBhbmltYXRpb25Eb21haW46IG51bGx9O1xuICBjb25zdCBzYW1wbGVUcmlwID0gZGF0YVRvRmVhdHVyZS5maW5kKFxuICAgIGYgPT5cbiAgICAgIGYgJiZcbiAgICAgIGYuZ2VvbWV0cnkgJiZcbiAgICAgIGYuZ2VvbWV0cnkuY29vcmRpbmF0ZXMgJiZcbiAgICAgIGYuZ2VvbWV0cnkuY29vcmRpbmF0ZXMubGVuZ3RoID49IDNcbiAgKTtcblxuICAvLyBpZiBubyB2YWxpZCBnZW9tZXRyeVxuICBpZiAoIXNhbXBsZVRyaXApIHtcbiAgICByZXR1cm4gZW1wdHk7XG4gIH1cblxuICBjb25zdCBhbmFseXplZFR5cGUgPSBjb250YWluVmFsaWRUaW1lKFxuICAgIHNhbXBsZVRyaXAuZ2VvbWV0cnkuY29vcmRpbmF0ZXMubWFwKGNvb3JkID0+IGNvb3JkWzNdKVxuICApO1xuXG4gIGlmICghYW5hbHl6ZWRUeXBlKSB7XG4gICAgcmV0dXJuIGVtcHR5O1xuICB9XG5cbiAgY29uc3Qge2Zvcm1hdH0gPSBhbmFseXplZFR5cGU7XG4gIGNvbnN0IGdldFRpbWVWYWx1ZSA9IGNvb3JkID0+XG4gICAgY29vcmQgJiYgbm90TnVsbG9yVW5kZWZpbmVkKGNvb3JkWzNdKVxuICAgICAgPyB0aW1lVG9Vbml4TWlsbGkoY29vcmRbM10sIGZvcm1hdClcbiAgICAgIDogbnVsbDtcblxuICBjb25zdCBkYXRhVG9UaW1lU3RhbXAgPSBkYXRhVG9GZWF0dXJlLm1hcChmID0+XG4gICAgZiAmJiBmLmdlb21ldHJ5ICYmIEFycmF5LmlzQXJyYXkoZi5nZW9tZXRyeS5jb29yZGluYXRlcylcbiAgICAgID8gZi5nZW9tZXRyeS5jb29yZGluYXRlcy5tYXAoZ2V0VGltZVZhbHVlKVxuICAgICAgOiBudWxsXG4gICk7XG5cbiAgY29uc3QgYW5pbWF0aW9uRG9tYWluID0gZ2V0QW5pbWF0aW9uRG9tYWluRnJvbVRpbWVzdGFtcHMoZGF0YVRvVGltZVN0YW1wKTtcblxuICByZXR1cm4ge2RhdGFUb1RpbWVTdGFtcCwgYW5pbWF0aW9uRG9tYWlufTtcbn1cblxuZnVuY3Rpb24gZmluZE1pbkZyb21Tb3J0ZWQobGlzdCA9IFtdKSB7XG4gIHJldHVybiBsaXN0LmZpbmQobm90TnVsbG9yVW5kZWZpbmVkKSB8fCBudWxsO1xufVxuXG5mdW5jdGlvbiBmaW5kTWF4RnJvbVNvcnRlZChsaXN0ID0gW10pIHtcbiAgbGV0IGkgPSBsaXN0Lmxlbmd0aCAtIDE7XG4gIHdoaWxlIChpID4gMCkge1xuICAgIGlmIChub3ROdWxsb3JVbmRlZmluZWQobGlzdFtpXSkpIHtcbiAgICAgIHJldHVybiBsaXN0W2ldXG4gICAgfVxuICAgIGktLTtcbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEFuaW1hdGlvbkRvbWFpbkZyb21UaW1lc3RhbXBzKGRhdGFUb1RpbWVTdGFtcCA9IFtdKSB7XG4gIHJldHVybiBkYXRhVG9UaW1lU3RhbXAucmVkdWNlKFxuICAgIChhY2N1LCB0c3MpID0+IHtcbiAgICAgIGFjY3VbMF0gPSBNYXRoLm1pbihhY2N1WzBdLCBmaW5kTWluRnJvbVNvcnRlZCh0c3MpKTtcbiAgICAgIGFjY3VbMV0gPSBNYXRoLm1heChhY2N1WzFdLCBmaW5kTWF4RnJvbVNvcnRlZCh0c3MpKTtcbiAgICAgIHJldHVybiBhY2N1O1xuICAgIH0sXG4gICAgW0luZmluaXR5LCAtSW5maW5pdHldXG4gICk7XG59XG4iXX0=