"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = PlotContainerFactory;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _reselect = require("reselect");

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _reactMapGl = require("react-map-gl");

var _lodash = _interopRequireDefault(require("lodash.debounce"));

var _notificationsUtils = require("../utils/notifications-utils");

var _mapContainer = _interopRequireDefault(require("./map-container"));

var _exportImageUtils = require("../utils/export-image-utils");

var _mapboxGlStyleEditor = require("../utils/map-style-utils/mapbox-gl-style-editor");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _templateObject() {
  var data = (0, _taggedTemplateLiteral2["default"])(["\n  .mapboxgl-ctrl-bottom-left,\n  .mapboxgl-ctrl-bottom-right {\n    display: none;\n  }\n"]);

  _templateObject = function _templateObject() {
    return data;
  };

  return data;
}

var propTypes = {
  width: _propTypes["default"].number.isRequired,
  height: _propTypes["default"].number.isRequired,
  exportImageSetting: _propTypes["default"].object.isRequired,
  addNotification: _propTypes["default"].func.isRequired,
  mapFields: _propTypes["default"].object.isRequired
};
PlotContainerFactory.deps = [_mapContainer["default"]]; // Remove mapbox logo in exported map, because it contains non-ascii characters

var StyledPlotContainer = _styledComponents["default"].div(_templateObject());

var deckGlProps = {
  glOptions: {
    preserveDrawingBuffer: true,
    useDevicePixels: false
  }
};

function PlotContainerFactory(MapContainer) {
  var PlotContainer =
  /*#__PURE__*/
  function (_Component) {
    (0, _inherits2["default"])(PlotContainer, _Component);

    function PlotContainer(_props) {
      var _this;

      (0, _classCallCheck2["default"])(this, PlotContainer);
      _this = (0, _possibleConstructorReturn2["default"])(this, (0, _getPrototypeOf2["default"])(PlotContainer).call(this, _props));
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "plottingAreaRef", (0, _react.createRef)());
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "mapStyleSelector", function (props) {
        return props.mapFields.mapStyle;
      });
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "resolutionSelector", function (props) {
        return props.exportImageSetting.resolution;
      });
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "scaledMapStyleSelector", (0, _reselect.createSelector)(_this.mapStyleSelector, _this.resolutionSelector, function (mapStyle, resolution) {
        return _objectSpread({}, mapStyle, {
          bottomMapStyle: (0, _mapboxGlStyleEditor.scaleMapStyleByResolution)(mapStyle.bottomMapStyle, resolution),
          topMapStyle: (0, _mapboxGlStyleEditor.scaleMapStyleByResolution)(mapStyle.topMapStyle, resolution)
        });
      }));
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "_onMapRender", function (map) {
        if (map.isStyleLoaded()) {
          _this._retrieveNewScreenshot();
        }
      });
      (0, _defineProperty2["default"])((0, _assertThisInitialized2["default"])(_this), "_retrieveNewScreenshot", function () {
        if (_this.plottingAreaRef.current) {
          _this.props.startExportingImage();

          var filter = function filter(node) {
            return node.className !== 'mapboxgl-control-container';
          };

          (0, _exportImageUtils.convertToPng)(_this.plottingAreaRef.current, {
            filter: filter
          }).then(function (dataUri) {
            _this.props.setExportImageDataUri(dataUri);
          })["catch"](function (err) {
            _this.props.setExportImageError(err);

            _this.props.addNotification((0, _notificationsUtils.exportImageError)({
              err: err
            }));
          });
        }
      });
      _this._onMapRender = (0, _lodash["default"])(_this._onMapRender, 500);
      return _this;
    }

    (0, _createClass2["default"])(PlotContainer, [{
      key: "componentWillMount",
      value: function componentWillMount() {
        this.props.startExportingImage();
      }
    }, {
      key: "componentWillReceiveProps",
      value: function componentWillReceiveProps(newProps) {
        var _this2 = this;

        // re-fetch the new screenshot only when ratio legend or resolution changes
        var checks = ['ratio', 'resolution', 'legend'];
        var shouldRetrieveScreenshot = checks.some(function (item) {
          return _this2.props.exportImageSetting[item] !== newProps.exportImageSetting[item];
        });

        if (shouldRetrieveScreenshot) {
          this._retrieveNewScreenshot();
        }
      }
    }, {
      key: "render",
      value: function render() {
        var _this$props = this.props,
            width = _this$props.width,
            height = _this$props.height,
            exportImageSetting = _this$props.exportImageSetting,
            mapFields = _this$props.mapFields;
        var ratio = exportImageSetting.ratio,
            resolution = exportImageSetting.resolution,
            legend = exportImageSetting.legend;
        var exportImageSize = (0, _exportImageUtils.calculateExportImageSize)({
          width: width,
          height: height,
          ratio: ratio,
          resolution: resolution
        });

        var mapProps = _objectSpread({}, mapFields, {
          mapStyle: this.scaledMapStyleSelector(this.props),
          // override viewport based on export settings
          mapState: _objectSpread({}, mapFields.mapState, {}, exportImageSize, {
            zoom: mapFields.mapState.zoom + exportImageSize.zoomOffset
          }),
          mapControls: {
            // override map legend visibility
            mapLegend: {
              show: legend,
              active: true
            }
          },
          MapComponent: _reactMapGl.StaticMap
        });

        return _react["default"].createElement(StyledPlotContainer, {
          style: {
            position: 'absolute',
            top: -9999,
            left: -9999
          }
        }, _react["default"].createElement("div", {
          ref: this.plottingAreaRef,
          style: {
            width: exportImageSize.width,
            height: exportImageSize.height
          }
        }, _react["default"].createElement(MapContainer, (0, _extends2["default"])({
          index: 0,
          onMapRender: this._onMapRender,
          isExport: true,
          deckGlProps: deckGlProps
        }, mapProps))));
      }
    }]);
    return PlotContainer;
  }(_react.Component);

  PlotContainer.propsTypes = propTypes;
  return PlotContainer;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21wb25lbnRzL3Bsb3QtY29udGFpbmVyLmpzIl0sIm5hbWVzIjpbInByb3BUeXBlcyIsIndpZHRoIiwiUHJvcFR5cGVzIiwibnVtYmVyIiwiaXNSZXF1aXJlZCIsImhlaWdodCIsImV4cG9ydEltYWdlU2V0dGluZyIsIm9iamVjdCIsImFkZE5vdGlmaWNhdGlvbiIsImZ1bmMiLCJtYXBGaWVsZHMiLCJQbG90Q29udGFpbmVyRmFjdG9yeSIsImRlcHMiLCJNYXBDb250YWluZXJGYWN0b3J5IiwiU3R5bGVkUGxvdENvbnRhaW5lciIsInN0eWxlZCIsImRpdiIsImRlY2tHbFByb3BzIiwiZ2xPcHRpb25zIiwicHJlc2VydmVEcmF3aW5nQnVmZmVyIiwidXNlRGV2aWNlUGl4ZWxzIiwiTWFwQ29udGFpbmVyIiwiUGxvdENvbnRhaW5lciIsInByb3BzIiwibWFwU3R5bGUiLCJyZXNvbHV0aW9uIiwibWFwU3R5bGVTZWxlY3RvciIsInJlc29sdXRpb25TZWxlY3RvciIsImJvdHRvbU1hcFN0eWxlIiwidG9wTWFwU3R5bGUiLCJtYXAiLCJpc1N0eWxlTG9hZGVkIiwiX3JldHJpZXZlTmV3U2NyZWVuc2hvdCIsInBsb3R0aW5nQXJlYVJlZiIsImN1cnJlbnQiLCJzdGFydEV4cG9ydGluZ0ltYWdlIiwiZmlsdGVyIiwibm9kZSIsImNsYXNzTmFtZSIsInRoZW4iLCJkYXRhVXJpIiwic2V0RXhwb3J0SW1hZ2VEYXRhVXJpIiwiZXJyIiwic2V0RXhwb3J0SW1hZ2VFcnJvciIsIl9vbk1hcFJlbmRlciIsIm5ld1Byb3BzIiwiY2hlY2tzIiwic2hvdWxkUmV0cmlldmVTY3JlZW5zaG90Iiwic29tZSIsIml0ZW0iLCJyYXRpbyIsImxlZ2VuZCIsImV4cG9ydEltYWdlU2l6ZSIsIm1hcFByb3BzIiwic2NhbGVkTWFwU3R5bGVTZWxlY3RvciIsIm1hcFN0YXRlIiwiem9vbSIsInpvb21PZmZzZXQiLCJtYXBDb250cm9scyIsIm1hcExlZ2VuZCIsInNob3ciLCJhY3RpdmUiLCJNYXBDb21wb25lbnQiLCJTdGF0aWNNYXAiLCJwb3NpdGlvbiIsInRvcCIsImxlZnQiLCJDb21wb25lbnQiLCJwcm9wc1R5cGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXFCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7OztBQUVBLElBQU1BLFNBQVMsR0FBRztBQUNoQkMsRUFBQUEsS0FBSyxFQUFFQyxzQkFBVUMsTUFBVixDQUFpQkMsVUFEUjtBQUVoQkMsRUFBQUEsTUFBTSxFQUFFSCxzQkFBVUMsTUFBVixDQUFpQkMsVUFGVDtBQUdoQkUsRUFBQUEsa0JBQWtCLEVBQUVKLHNCQUFVSyxNQUFWLENBQWlCSCxVQUhyQjtBQUloQkksRUFBQUEsZUFBZSxFQUFFTixzQkFBVU8sSUFBVixDQUFlTCxVQUpoQjtBQUtoQk0sRUFBQUEsU0FBUyxFQUFFUixzQkFBVUssTUFBVixDQUFpQkg7QUFMWixDQUFsQjtBQVFBTyxvQkFBb0IsQ0FBQ0MsSUFBckIsR0FBNEIsQ0FBQ0Msd0JBQUQsQ0FBNUIsQyxDQUVBOztBQUNBLElBQU1DLG1CQUFtQixHQUFHQyw2QkFBT0MsR0FBVixtQkFBekI7O0FBT0EsSUFBTUMsV0FBVyxHQUFHO0FBQ2xCQyxFQUFBQSxTQUFTLEVBQUU7QUFDVEMsSUFBQUEscUJBQXFCLEVBQUUsSUFEZDtBQUVUQyxJQUFBQSxlQUFlLEVBQUU7QUFGUjtBQURPLENBQXBCOztBQU9lLFNBQVNULG9CQUFULENBQThCVSxZQUE5QixFQUE0QztBQUFBLE1BQ25EQyxhQURtRDtBQUFBO0FBQUE7QUFBQTs7QUFFdkQsMkJBQVlDLE1BQVosRUFBbUI7QUFBQTs7QUFBQTtBQUNqQiwySEFBTUEsTUFBTjtBQURpQiwwR0FzQkQsdUJBdEJDO0FBQUEsMkdBd0JBLFVBQUFBLEtBQUs7QUFBQSxlQUFJQSxLQUFLLENBQUNiLFNBQU4sQ0FBZ0JjLFFBQXBCO0FBQUEsT0F4Qkw7QUFBQSw2R0F5QkUsVUFBQUQsS0FBSztBQUFBLGVBQUlBLEtBQUssQ0FBQ2pCLGtCQUFOLENBQXlCbUIsVUFBN0I7QUFBQSxPQXpCUDtBQUFBLGlIQTBCTSw4QkFDdkIsTUFBS0MsZ0JBRGtCLEVBRXZCLE1BQUtDLGtCQUZrQixFQUd2QixVQUFDSCxRQUFELEVBQVdDLFVBQVg7QUFBQSxpQ0FDS0QsUUFETDtBQUVFSSxVQUFBQSxjQUFjLEVBQUUsb0RBQ2RKLFFBQVEsQ0FBQ0ksY0FESyxFQUVkSCxVQUZjLENBRmxCO0FBTUVJLFVBQUFBLFdBQVcsRUFBRSxvREFBMEJMLFFBQVEsQ0FBQ0ssV0FBbkMsRUFBZ0RKLFVBQWhEO0FBTmY7QUFBQSxPQUh1QixDQTFCTjtBQUFBLHVHQXVDSixVQUFBSyxHQUFHLEVBQUk7QUFDcEIsWUFBSUEsR0FBRyxDQUFDQyxhQUFKLEVBQUosRUFBeUI7QUFDdkIsZ0JBQUtDLHNCQUFMO0FBQ0Q7QUFDRixPQTNDa0I7QUFBQSxpSEE2Q00sWUFBTTtBQUM3QixZQUFJLE1BQUtDLGVBQUwsQ0FBcUJDLE9BQXpCLEVBQWtDO0FBQ2hDLGdCQUFLWCxLQUFMLENBQVdZLG1CQUFYOztBQUNBLGNBQU1DLE1BQU0sR0FBRyxTQUFUQSxNQUFTLENBQUFDLElBQUk7QUFBQSxtQkFBSUEsSUFBSSxDQUFDQyxTQUFMLEtBQW1CLDRCQUF2QjtBQUFBLFdBQW5COztBQUVBLDhDQUFhLE1BQUtMLGVBQUwsQ0FBcUJDLE9BQWxDLEVBQTJDO0FBQUNFLFlBQUFBLE1BQU0sRUFBTkE7QUFBRCxXQUEzQyxFQUFxREcsSUFBckQsQ0FBMEQsVUFBQUMsT0FBTyxFQUFJO0FBQ25FLGtCQUFLakIsS0FBTCxDQUFXa0IscUJBQVgsQ0FBaUNELE9BQWpDO0FBQ0QsV0FGRCxXQUdPLFVBQUFFLEdBQUcsRUFBSTtBQUNaLGtCQUFLbkIsS0FBTCxDQUFXb0IsbUJBQVgsQ0FBK0JELEdBQS9COztBQUNBLGtCQUFLbkIsS0FBTCxDQUFXZixlQUFYLENBQTJCLDBDQUFpQjtBQUFDa0MsY0FBQUEsR0FBRyxFQUFIQTtBQUFELGFBQWpCLENBQTNCO0FBQ0QsV0FORDtBQU9EO0FBQ0YsT0ExRGtCO0FBRWpCLFlBQUtFLFlBQUwsR0FBb0Isd0JBQVMsTUFBS0EsWUFBZCxFQUE0QixHQUE1QixDQUFwQjtBQUZpQjtBQUdsQjs7QUFMc0Q7QUFBQTtBQUFBLDJDQU9sQztBQUNuQixhQUFLckIsS0FBTCxDQUFXWSxtQkFBWDtBQUNEO0FBVHNEO0FBQUE7QUFBQSxnREFXN0JVLFFBWDZCLEVBV25CO0FBQUE7O0FBQ2xDO0FBQ0EsWUFBTUMsTUFBTSxHQUFHLENBQUMsT0FBRCxFQUFVLFlBQVYsRUFBd0IsUUFBeEIsQ0FBZjtBQUNBLFlBQU1DLHdCQUF3QixHQUFHRCxNQUFNLENBQUNFLElBQVAsQ0FDL0IsVUFBQUMsSUFBSTtBQUFBLGlCQUNGLE1BQUksQ0FBQzFCLEtBQUwsQ0FBV2pCLGtCQUFYLENBQThCMkMsSUFBOUIsTUFDQUosUUFBUSxDQUFDdkMsa0JBQVQsQ0FBNEIyQyxJQUE1QixDQUZFO0FBQUEsU0FEMkIsQ0FBakM7O0FBS0EsWUFBSUYsd0JBQUosRUFBOEI7QUFDNUIsZUFBS2Ysc0JBQUw7QUFDRDtBQUNGO0FBdEJzRDtBQUFBO0FBQUEsK0JBOEQ5QztBQUFBLDBCQUNnRCxLQUFLVCxLQURyRDtBQUFBLFlBQ0F0QixLQURBLGVBQ0FBLEtBREE7QUFBQSxZQUNPSSxNQURQLGVBQ09BLE1BRFA7QUFBQSxZQUNlQyxrQkFEZixlQUNlQSxrQkFEZjtBQUFBLFlBQ21DSSxTQURuQyxlQUNtQ0EsU0FEbkM7QUFBQSxZQUVBd0MsS0FGQSxHQUU2QjVDLGtCQUY3QixDQUVBNEMsS0FGQTtBQUFBLFlBRU96QixVQUZQLEdBRTZCbkIsa0JBRjdCLENBRU9tQixVQUZQO0FBQUEsWUFFbUIwQixNQUZuQixHQUU2QjdDLGtCQUY3QixDQUVtQjZDLE1BRm5CO0FBR1AsWUFBTUMsZUFBZSxHQUFHLGdEQUF5QjtBQUMvQ25ELFVBQUFBLEtBQUssRUFBTEEsS0FEK0M7QUFFL0NJLFVBQUFBLE1BQU0sRUFBTkEsTUFGK0M7QUFHL0M2QyxVQUFBQSxLQUFLLEVBQUxBLEtBSCtDO0FBSS9DekIsVUFBQUEsVUFBVSxFQUFWQTtBQUorQyxTQUF6QixDQUF4Qjs7QUFPQSxZQUFNNEIsUUFBUSxxQkFDVDNDLFNBRFM7QUFFWmMsVUFBQUEsUUFBUSxFQUFFLEtBQUs4QixzQkFBTCxDQUE0QixLQUFLL0IsS0FBakMsQ0FGRTtBQUlaO0FBQ0FnQyxVQUFBQSxRQUFRLG9CQUNIN0MsU0FBUyxDQUFDNkMsUUFEUCxNQUVISCxlQUZHO0FBR05JLFlBQUFBLElBQUksRUFBRTlDLFNBQVMsQ0FBQzZDLFFBQVYsQ0FBbUJDLElBQW5CLEdBQTBCSixlQUFlLENBQUNLO0FBSDFDLFlBTEk7QUFVWkMsVUFBQUEsV0FBVyxFQUFFO0FBQ1g7QUFDQUMsWUFBQUEsU0FBUyxFQUFFO0FBQ1RDLGNBQUFBLElBQUksRUFBRVQsTUFERztBQUVUVSxjQUFBQSxNQUFNLEVBQUU7QUFGQztBQUZBLFdBVkQ7QUFpQlpDLFVBQUFBLFlBQVksRUFBRUM7QUFqQkYsVUFBZDs7QUFvQkEsZUFDRSxnQ0FBQyxtQkFBRDtBQUNFLFVBQUEsS0FBSyxFQUFFO0FBQUNDLFlBQUFBLFFBQVEsRUFBRSxVQUFYO0FBQXVCQyxZQUFBQSxHQUFHLEVBQUUsQ0FBQyxJQUE3QjtBQUFtQ0MsWUFBQUEsSUFBSSxFQUFFLENBQUM7QUFBMUM7QUFEVCxXQUdFO0FBQ0UsVUFBQSxHQUFHLEVBQUUsS0FBS2pDLGVBRFo7QUFFRSxVQUFBLEtBQUssRUFBRTtBQUNMaEMsWUFBQUEsS0FBSyxFQUFFbUQsZUFBZSxDQUFDbkQsS0FEbEI7QUFFTEksWUFBQUEsTUFBTSxFQUFFK0MsZUFBZSxDQUFDL0M7QUFGbkI7QUFGVCxXQU9FLGdDQUFDLFlBQUQ7QUFDRSxVQUFBLEtBQUssRUFBRSxDQURUO0FBRUUsVUFBQSxXQUFXLEVBQUUsS0FBS3VDLFlBRnBCO0FBR0UsVUFBQSxRQUFRLE1BSFY7QUFJRSxVQUFBLFdBQVcsRUFBRTNCO0FBSmYsV0FLTW9DLFFBTE4sRUFQRixDQUhGLENBREY7QUFxQkQ7QUFqSHNEO0FBQUE7QUFBQSxJQUM3QmMsZ0JBRDZCOztBQW9IekQ3QyxFQUFBQSxhQUFhLENBQUM4QyxVQUFkLEdBQTJCcEUsU0FBM0I7QUFDQSxTQUFPc0IsYUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDE5IFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cblxuLy8gbGlicmFyaWVzXG5pbXBvcnQgUmVhY3QsIHtDb21wb25lbnQsIGNyZWF0ZVJlZn0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCB7Y3JlYXRlU2VsZWN0b3J9IGZyb20gJ3Jlc2VsZWN0JztcbmltcG9ydCBzdHlsZWQgZnJvbSAnc3R5bGVkLWNvbXBvbmVudHMnO1xuaW1wb3J0IHtTdGF0aWNNYXB9IGZyb20gJ3JlYWN0LW1hcC1nbCc7XG5pbXBvcnQgZGVib3VuY2UgZnJvbSAnbG9kYXNoLmRlYm91bmNlJztcbmltcG9ydCB7ZXhwb3J0SW1hZ2VFcnJvcn0gZnJvbSAndXRpbHMvbm90aWZpY2F0aW9ucy11dGlscyc7XG5pbXBvcnQgTWFwQ29udGFpbmVyRmFjdG9yeSBmcm9tICcuL21hcC1jb250YWluZXInO1xuaW1wb3J0IHtjYWxjdWxhdGVFeHBvcnRJbWFnZVNpemUsIGNvbnZlcnRUb1BuZ30gZnJvbSAndXRpbHMvZXhwb3J0LWltYWdlLXV0aWxzJztcbmltcG9ydCB7c2NhbGVNYXBTdHlsZUJ5UmVzb2x1dGlvbn0gZnJvbSAndXRpbHMvbWFwLXN0eWxlLXV0aWxzL21hcGJveC1nbC1zdHlsZS1lZGl0b3InO1xuXG5jb25zdCBwcm9wVHlwZXMgPSB7XG4gIHdpZHRoOiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXG4gIGhlaWdodDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLFxuICBleHBvcnRJbWFnZVNldHRpbmc6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgYWRkTm90aWZpY2F0aW9uOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuICBtYXBGaWVsZHM6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZFxufTtcblxuUGxvdENvbnRhaW5lckZhY3RvcnkuZGVwcyA9IFtNYXBDb250YWluZXJGYWN0b3J5XTtcblxuLy8gUmVtb3ZlIG1hcGJveCBsb2dvIGluIGV4cG9ydGVkIG1hcCwgYmVjYXVzZSBpdCBjb250YWlucyBub24tYXNjaWkgY2hhcmFjdGVyc1xuY29uc3QgU3R5bGVkUGxvdENvbnRhaW5lciA9IHN0eWxlZC5kaXZgXG4gIC5tYXBib3hnbC1jdHJsLWJvdHRvbS1sZWZ0LFxuICAubWFwYm94Z2wtY3RybC1ib3R0b20tcmlnaHQge1xuICAgIGRpc3BsYXk6IG5vbmU7XG4gIH1cbmA7XG5cbmNvbnN0IGRlY2tHbFByb3BzID0ge1xuICBnbE9wdGlvbnM6IHtcbiAgICBwcmVzZXJ2ZURyYXdpbmdCdWZmZXI6IHRydWUsXG4gICAgdXNlRGV2aWNlUGl4ZWxzOiBmYWxzZVxuICB9XG59O1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBQbG90Q29udGFpbmVyRmFjdG9yeShNYXBDb250YWluZXIpIHtcbiAgY2xhc3MgUGxvdENvbnRhaW5lciBleHRlbmRzIENvbXBvbmVudCB7XG4gICAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgIHRoaXMuX29uTWFwUmVuZGVyID0gZGVib3VuY2UodGhpcy5fb25NYXBSZW5kZXIsIDUwMCk7XG4gICAgfVxuXG4gICAgY29tcG9uZW50V2lsbE1vdW50KCkge1xuICAgICAgdGhpcy5wcm9wcy5zdGFydEV4cG9ydGluZ0ltYWdlKCk7XG4gICAgfVxuXG4gICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXdQcm9wcykge1xuICAgICAgLy8gcmUtZmV0Y2ggdGhlIG5ldyBzY3JlZW5zaG90IG9ubHkgd2hlbiByYXRpbyBsZWdlbmQgb3IgcmVzb2x1dGlvbiBjaGFuZ2VzXG4gICAgICBjb25zdCBjaGVja3MgPSBbJ3JhdGlvJywgJ3Jlc29sdXRpb24nLCAnbGVnZW5kJ107XG4gICAgICBjb25zdCBzaG91bGRSZXRyaWV2ZVNjcmVlbnNob3QgPSBjaGVja3Muc29tZShcbiAgICAgICAgaXRlbSA9PlxuICAgICAgICAgIHRoaXMucHJvcHMuZXhwb3J0SW1hZ2VTZXR0aW5nW2l0ZW1dICE9PVxuICAgICAgICAgIG5ld1Byb3BzLmV4cG9ydEltYWdlU2V0dGluZ1tpdGVtXVxuICAgICAgKTtcbiAgICAgIGlmIChzaG91bGRSZXRyaWV2ZVNjcmVlbnNob3QpIHtcbiAgICAgICAgdGhpcy5fcmV0cmlldmVOZXdTY3JlZW5zaG90KCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcGxvdHRpbmdBcmVhUmVmID0gY3JlYXRlUmVmKCk7XG5cbiAgICBtYXBTdHlsZVNlbGVjdG9yID0gcHJvcHMgPT4gcHJvcHMubWFwRmllbGRzLm1hcFN0eWxlO1xuICAgIHJlc29sdXRpb25TZWxlY3RvciA9IHByb3BzID0+IHByb3BzLmV4cG9ydEltYWdlU2V0dGluZy5yZXNvbHV0aW9uO1xuICAgIHNjYWxlZE1hcFN0eWxlU2VsZWN0b3IgPSBjcmVhdGVTZWxlY3RvcihcbiAgICAgIHRoaXMubWFwU3R5bGVTZWxlY3RvcixcbiAgICAgIHRoaXMucmVzb2x1dGlvblNlbGVjdG9yLFxuICAgICAgKG1hcFN0eWxlLCByZXNvbHV0aW9uKSA9PiAoe1xuICAgICAgICAuLi5tYXBTdHlsZSxcbiAgICAgICAgYm90dG9tTWFwU3R5bGU6IHNjYWxlTWFwU3R5bGVCeVJlc29sdXRpb24oXG4gICAgICAgICAgbWFwU3R5bGUuYm90dG9tTWFwU3R5bGUsXG4gICAgICAgICAgcmVzb2x1dGlvblxuICAgICAgICApLFxuICAgICAgICB0b3BNYXBTdHlsZTogc2NhbGVNYXBTdHlsZUJ5UmVzb2x1dGlvbihtYXBTdHlsZS50b3BNYXBTdHlsZSwgcmVzb2x1dGlvbilcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIF9vbk1hcFJlbmRlciA9IG1hcCA9PiB7XG4gICAgICBpZiAobWFwLmlzU3R5bGVMb2FkZWQoKSkge1xuICAgICAgICB0aGlzLl9yZXRyaWV2ZU5ld1NjcmVlbnNob3QoKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgX3JldHJpZXZlTmV3U2NyZWVuc2hvdCA9ICgpID0+IHtcbiAgICAgIGlmICh0aGlzLnBsb3R0aW5nQXJlYVJlZi5jdXJyZW50KSB7XG4gICAgICAgIHRoaXMucHJvcHMuc3RhcnRFeHBvcnRpbmdJbWFnZSgpO1xuICAgICAgICBjb25zdCBmaWx0ZXIgPSBub2RlID0+IG5vZGUuY2xhc3NOYW1lICE9PSAnbWFwYm94Z2wtY29udHJvbC1jb250YWluZXInO1xuXG4gICAgICAgIGNvbnZlcnRUb1BuZyh0aGlzLnBsb3R0aW5nQXJlYVJlZi5jdXJyZW50LCB7ZmlsdGVyfSkudGhlbihkYXRhVXJpID0+IHtcbiAgICAgICAgICB0aGlzLnByb3BzLnNldEV4cG9ydEltYWdlRGF0YVVyaShkYXRhVXJpKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgdGhpcy5wcm9wcy5zZXRFeHBvcnRJbWFnZUVycm9yKGVycik7XG4gICAgICAgICAgdGhpcy5wcm9wcy5hZGROb3RpZmljYXRpb24oZXhwb3J0SW1hZ2VFcnJvcih7ZXJyfSkpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgcmVuZGVyKCkge1xuICAgICAgY29uc3Qge3dpZHRoLCBoZWlnaHQsIGV4cG9ydEltYWdlU2V0dGluZywgbWFwRmllbGRzfSA9IHRoaXMucHJvcHM7XG4gICAgICBjb25zdCB7cmF0aW8sIHJlc29sdXRpb24sIGxlZ2VuZH0gPSBleHBvcnRJbWFnZVNldHRpbmc7XG4gICAgICBjb25zdCBleHBvcnRJbWFnZVNpemUgPSBjYWxjdWxhdGVFeHBvcnRJbWFnZVNpemUoe1xuICAgICAgICB3aWR0aCxcbiAgICAgICAgaGVpZ2h0LFxuICAgICAgICByYXRpbyxcbiAgICAgICAgcmVzb2x1dGlvblxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IG1hcFByb3BzID0ge1xuICAgICAgICAuLi5tYXBGaWVsZHMsXG4gICAgICAgIG1hcFN0eWxlOiB0aGlzLnNjYWxlZE1hcFN0eWxlU2VsZWN0b3IodGhpcy5wcm9wcyksXG5cbiAgICAgICAgLy8gb3ZlcnJpZGUgdmlld3BvcnQgYmFzZWQgb24gZXhwb3J0IHNldHRpbmdzXG4gICAgICAgIG1hcFN0YXRlOiB7XG4gICAgICAgICAgLi4ubWFwRmllbGRzLm1hcFN0YXRlLFxuICAgICAgICAgIC4uLmV4cG9ydEltYWdlU2l6ZSxcbiAgICAgICAgICB6b29tOiBtYXBGaWVsZHMubWFwU3RhdGUuem9vbSArIGV4cG9ydEltYWdlU2l6ZS56b29tT2Zmc2V0XG4gICAgICAgIH0sXG4gICAgICAgIG1hcENvbnRyb2xzOiB7XG4gICAgICAgICAgLy8gb3ZlcnJpZGUgbWFwIGxlZ2VuZCB2aXNpYmlsaXR5XG4gICAgICAgICAgbWFwTGVnZW5kOiB7XG4gICAgICAgICAgICBzaG93OiBsZWdlbmQsXG4gICAgICAgICAgICBhY3RpdmU6IHRydWVcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIE1hcENvbXBvbmVudDogU3RhdGljTWFwXG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gKFxuICAgICAgICA8U3R5bGVkUGxvdENvbnRhaW5lclxuICAgICAgICAgIHN0eWxlPXt7cG9zaXRpb246ICdhYnNvbHV0ZScsIHRvcDogLTk5OTksIGxlZnQ6IC05OTk5fX1cbiAgICAgICAgPlxuICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgIHJlZj17dGhpcy5wbG90dGluZ0FyZWFSZWZ9XG4gICAgICAgICAgICBzdHlsZT17e1xuICAgICAgICAgICAgICB3aWR0aDogZXhwb3J0SW1hZ2VTaXplLndpZHRoLFxuICAgICAgICAgICAgICBoZWlnaHQ6IGV4cG9ydEltYWdlU2l6ZS5oZWlnaHRcbiAgICAgICAgICAgIH19XG4gICAgICAgICAgPlxuICAgICAgICAgICAgPE1hcENvbnRhaW5lclxuICAgICAgICAgICAgICBpbmRleD17MH1cbiAgICAgICAgICAgICAgb25NYXBSZW5kZXI9e3RoaXMuX29uTWFwUmVuZGVyfVxuICAgICAgICAgICAgICBpc0V4cG9ydFxuICAgICAgICAgICAgICBkZWNrR2xQcm9wcz17ZGVja0dsUHJvcHN9XG4gICAgICAgICAgICAgIHsuLi5tYXBQcm9wc31cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvU3R5bGVkUGxvdENvbnRhaW5lcj5cbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgUGxvdENvbnRhaW5lci5wcm9wc1R5cGVzID0gcHJvcFR5cGVzO1xuICByZXR1cm4gUGxvdENvbnRhaW5lcjtcbn1cbiJdfQ==